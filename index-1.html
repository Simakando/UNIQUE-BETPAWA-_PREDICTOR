<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BetPawa Predictor Ultra v3.0</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600;700;900&display=swap');

  :root {
    --primary: #1a472a; --primary-light: #00c851;
    --secondary: #07071a; --accent: #ff6b35;
    --gold: #ffd700; --gold2: #ffaa00;
    --danger: #ff3547; --bg: #050510;
    --card: #0d0d20; --card2: #13132a; --card3: #18183a;
    --text: #e8e8f5; --text2: #7878a0;
    --border: #22224a; --green: #00c851; --red: #ff3547;
    --blue: #4a9eff; --orange: #ff9800; --purple: #a855f7;
    --trap: #ff3547; --variance: #ff9800; --underdog: #a855f7;
    --acca: #ffd700; --ml: #00bcd4;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; font-size: 13px; min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(ellipse at 20% 0%, rgba(0,200,81,0.07) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(255,215,0,0.05) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }

  /* HEADER */
  .header { background: linear-gradient(135deg, #0f0f2a 0%, #07071a 100%); border-bottom: 2px solid rgba(255,215,0,0.4); padding: 10px 15px; text-align: center; position: sticky; top: 0; z-index: 1000; }
  .header-title { font-family: 'Rajdhani', sans-serif; font-size: 18px; font-weight: 700; color: var(--gold); text-transform: uppercase; letter-spacing: 3px; }
  .header-sub { font-size: 9px; color: var(--text2); margin-top: 2px; }
  .accuracy-badge { display: inline-block; background: linear-gradient(135deg, var(--green), #007a30); color: #000; padding: 3px 12px; border-radius: 20px; font-size: 9px; font-weight: 700; margin-top: 5px; animation: pulse 2s infinite; }
  .version-badge { display: inline-block; background: linear-gradient(135deg, var(--purple), #6a0dad); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 8px; font-weight: 700; margin-left: 5px; }
  @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.04)} }

  /* DATA QUALITY BAR */
  .data-quality-bar { background: linear-gradient(90deg, #0a0a1f, #0f102a, #0a0a1f); border-bottom: 1px solid var(--purple); padding: 5px 12px; display: flex; align-items: center; justify-content: space-between; font-size: 9px; gap: 6px; flex-wrap: wrap; }
  .dq-item { display: flex; align-items: center; gap: 4px; }
  .dq-dot { width: 6px; height: 6px; border-radius: 50%; }
  .dq-dot.real { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dq-dot.static { background: var(--orange); }
  .dq-dot.loading { background: var(--blue); animation: blink 0.8s infinite; }
  .dq-label { color: var(--text2); } .dq-value { color: var(--text); font-weight: 700; } .dq-matches { color: var(--purple); font-weight: 700; }

  /* LIVE STATUS BAR */
  .live-status-bar { background: linear-gradient(90deg, #060f06, #0a1a0a, #060f06); border-bottom: 1px solid rgba(0,200,81,0.3); padding: 7px 12px; display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
  .live-indicator { display: flex; align-items: center; gap: 5px; font-size: 10px; font-weight: 700; }
  .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: blink 1s infinite; }
  .live-dot.offline { background: var(--red); animation: none; }
  .live-dot.loading { background: var(--blue); animation: blink 0.5s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }
  .season-info { font-size: 11px; font-weight: 700; color: var(--gold); }
  .matchday-info { font-size: 11px; color: var(--text2); }
  .countdown-box { background: rgba(255,215,0,0.12); border: 1px solid rgba(255,215,0,0.4); border-radius: 6px; padding: 4px 10px; font-size: 12px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; min-width: 75px; text-align: center; }
  .refresh-btn { background: rgba(0,200,81,0.1); border: 1px solid var(--green); border-radius: 5px; color: var(--green); font-size: 9px; font-weight: 700; padding: 4px 9px; cursor: pointer; transition: all 0.2s; }
  .refresh-btn:hover { background: var(--green); color: #000; }

  /* LEAGUE SELECTOR */
  .league-selector { display: flex; gap: 5px; padding: 8px 10px; overflow-x: auto; background: var(--card); border-bottom: 1px solid var(--border); scrollbar-width: none; }
  .league-selector::-webkit-scrollbar { display: none; }
  .league-btn { flex: 0 0 auto; padding: 5px 12px; background: var(--card2); border: 1px solid var(--border); border-radius: 20px; color: var(--text2); font-size: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .league-btn.active, .league-btn:hover { background: rgba(0,200,81,0.15); border-color: var(--primary-light); color: var(--gold); }

  /* TABS */
  .tabs { display: flex; background: var(--secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; overflow-x: auto; scrollbar-width: none; }
  .tabs::-webkit-scrollbar { display: none; }
  .tab { flex: 0 0 auto; padding: 9px 8px; font-size: 9px; font-weight: 700; cursor: pointer; color: var(--text2); border-bottom: 2px solid transparent; margin-bottom: -1px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; white-space: nowrap; }
  .tab.active { color: var(--primary-light); border-bottom-color: var(--primary-light); background: rgba(0,200,81,0.07); }

  /* SECTIONS */
  .section { display: none; padding: 10px; padding-bottom: 90px; }
  .section.active { display: block; }

  /* LIVE PREDICTIONS */
  .live-predictions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 10px; background: linear-gradient(135deg, rgba(255,215,0,0.08), rgba(0,200,81,0.04)); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; }
  .live-pred-title { font-size: 11px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
  .high-conf-badge { background: var(--green); color: #000; font-size: 9px; font-weight: 900; padding: 3px 8px; border-radius: 10px; }

  /* PREDICTION CARDS */
  .pred-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 8px; position: relative; overflow: hidden; }
  .pred-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--green), transparent); }
  .pred-card.ultra-conf::before { background: linear-gradient(90deg, transparent, var(--gold), transparent); }
  .pred-card.high-conf { border-color: rgba(0,200,81,0.4); background: linear-gradient(135deg, rgba(0,200,81,0.05), rgba(0,0,0,0)); }
  .pred-card.ultra-conf { border-color: rgba(255,215,0,0.5); background: linear-gradient(135deg, rgba(255,215,0,0.06), rgba(0,0,0,0)); box-shadow: 0 0 20px rgba(255,215,0,0.1); }
  .pred-card.trap-warned { border-color: rgba(255,53,71,0.5) !important; }
  .pred-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .pred-match-name { font-size: 15px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .pred-league-tag { font-size: 9px; color: var(--text2); background: var(--card2); padding: 2px 6px; border-radius: 4px; margin-top: 3px; display: inline-block; }
  .pred-conf-badge { font-size: 14px; font-weight: 900; padding: 4px 10px; border-radius: 10px; font-family: 'Rajdhani', sans-serif; }
  .conf-ultra { background: rgba(255,215,0,0.15); color: var(--gold); border: 1px solid rgba(255,215,0,0.3); }
  .conf-high { background: rgba(0,200,81,0.15); color: var(--green); border: 1px solid rgba(0,200,81,0.3); }
  .pred-main-bet { background: linear-gradient(135deg, rgba(0,200,81,0.1), rgba(0,100,40,0.05)); border: 1px solid rgba(0,200,81,0.3); border-radius: 8px; padding: 8px 12px; text-align: center; margin-bottom: 8px; }
  .pred-bet-label { font-size: 8px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .pred-bet-value { font-size: 17px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }

  /* TRAP PANEL */
  .trap-panel { background: rgba(255,53,71,0.08); border: 1px solid rgba(255,53,71,0.4); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
  .trap-panel-title { font-size: 9px; font-weight: 900; color: var(--red); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
  .trap-item { font-size: 9px; color: #ff8a8a; padding: 2px 0; display: flex; align-items: flex-start; gap: 5px; }
  .trap-icon { min-width: 12px; }
  .trap-level { font-size: 8px; padding: 1px 5px; border-radius: 4px; font-weight: 700; }
  .tl-high { background: rgba(255,53,71,0.3); color: var(--red); }
  .tl-med { background: rgba(255,152,0,0.3); color: var(--orange); }
  .tl-low { background: rgba(255,255,100,0.2); color: #ffff60; }

  /* VARIANCE PANEL */
  .variance-panel { background: rgba(255,152,0,0.08); border: 1px solid rgba(255,152,0,0.4); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
  .variance-title { font-size: 9px; font-weight: 900; color: var(--orange); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
  .variance-item { font-size: 9px; color: #ffcc80; padding: 2px 0; display: flex; align-items: flex-start; gap: 5px; }
  .variance-score-bar { height: 8px; background: var(--card3); border-radius: 4px; overflow: hidden; margin-top: 5px; }
  .variance-score-fill { height: 100%; background: linear-gradient(90deg, var(--orange), var(--red)); border-radius: 4px; }

  /* UNDERDOG PANEL */
  .underdog-panel { background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.4); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
  .underdog-title { font-size: 9px; font-weight: 900; color: var(--purple); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
  .underdog-item { font-size: 9px; color: #d4a4f8; padding: 2px 0; display: flex; align-items: flex-start; gap: 5px; }

  /* DETAILED ANALYSIS */
  .analysis-panel { background: linear-gradient(135deg, rgba(74,158,255,0.06), rgba(0,200,81,0.03)); border: 1px solid rgba(74,158,255,0.3); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
  .analysis-title { font-size: 9px; font-weight: 900; color: var(--blue); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .analysis-row { display: flex; justify-content: space-between; align-items: center; font-size: 9px; padding: 3px 0; border-bottom: 1px solid rgba(34,34,74,0.4); }
  .analysis-row:last-child { border-bottom: none; }
  .analysis-label { color: var(--text2); }
  .analysis-value { font-weight: 700; color: var(--text); }
  .analysis-verdict { background: rgba(0,200,81,0.1); border: 1px solid rgba(0,200,81,0.3); border-radius: 6px; padding: 6px 8px; margin-top: 6px; font-size: 10px; color: var(--green); font-weight: 600; line-height: 1.5; }
  .analysis-verdict.risky { background: rgba(255,152,0,0.1); border-color: rgba(255,152,0,0.3); color: var(--orange); }
  .analysis-verdict.danger { background: rgba(255,53,71,0.1); border-color: rgba(255,53,71,0.3); color: var(--red); }

  /* ACCA BUILDER PANEL */
  .acca-panel { background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,152,0,0.05)); border: 2px solid rgba(255,215,0,0.5); border-radius: 12px; padding: 12px; margin: 10px 0; box-shadow: 0 0 20px rgba(255,215,0,0.08); }
  .acca-title { font-family: 'Rajdhani', sans-serif; font-size: 16px; font-weight: 900; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; text-align: center; }
  .acca-subtitle { font-size: 9px; color: var(--text2); text-align: center; margin-bottom: 10px; }
  .acca-legs { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
  .acca-leg { background: var(--card2); border: 1px solid var(--border); border-radius: 7px; padding: 8px; display: flex; justify-content: space-between; align-items: center; }
  .acca-leg.clean { border-color: rgba(0,200,81,0.3); }
  .acca-leg-match { font-size: 12px; font-weight: 700; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .acca-leg-bet { font-size: 10px; color: var(--green); font-weight: 700; }
  .acca-leg-right { text-align: right; }
  .acca-leg-odds { font-size: 14px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .acca-leg-conf { font-size: 8px; color: var(--text2); }
  .acca-totals { background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; padding: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
  .acca-total-item { }
  .acca-total-label { font-size: 8px; color: var(--text2); text-transform: uppercase; }
  .acca-total-value { font-size: 18px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .acca-protection { font-size: 9px; color: var(--red); margin-top: 8px; text-align: center; }
  .acca-empty { text-align: center; padding: 15px; color: var(--text2); font-size: 10px; }

  /* REAL STATS */
  .real-stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
  .real-stat-box { background: var(--card2); border-radius: 6px; padding: 6px 8px; text-align: center; }
  .real-stat-team { font-size: 10px; font-weight: 700; color: var(--gold); margin-bottom: 4px; }
  .real-stat-grid { display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; }
  .stat-pill { font-size: 8px; font-weight: 700; padding: 2px 5px; border-radius: 4px; }
  .sp-over { background: rgba(0,200,81,0.2); color: var(--green); }
  .sp-btts { background: rgba(74,158,255,0.2); color: var(--blue); }
  .sp-form { background: rgba(255,215,0,0.2); color: var(--gold); }
  .form-boxes-row { display: flex; gap: 3px; justify-content: center; margin-top: 4px; }
  .form-box-mini { width: 16px; height: 16px; border-radius: 3px; font-size: 8px; font-weight: 900; display: flex; align-items: center; justify-content: center; }
  .fb-over { background: rgba(0,200,81,0.3); color: var(--green); }
  .fb-under { background: rgba(255,53,71,0.3); color: var(--red); }
  .fb-na { background: rgba(100,100,130,0.3); color: var(--text2); }

  .pred-card-body { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
  .pred-info-item { background: var(--card2); padding: 6px 8px; border-radius: 6px; }
  .pred-info-label { font-size: 8px; color: var(--text2); text-transform: uppercase; margin-bottom: 2px; }
  .pred-info-value { font-size: 10px; font-weight: 700; color: var(--text); }
  .pred-countdown { display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 10px; color: var(--text2); }
  .pred-countdown .time { color: var(--orange); font-weight: 700; font-family: 'Rajdhani', sans-serif; }
  .pred-countdown .time.urgent { color: var(--red); animation: pulse 1s infinite; }

  /* STATS LOADER */
  .stats-loader { background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(0,200,81,0.04)); border: 1px solid rgba(168,85,247,0.3); border-radius: 8px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
  .stats-loader-icon { font-size: 20px; }
  .stats-loader-text { font-size: 10px; color: var(--text2); }
  .stats-loader-title { font-size: 11px; font-weight: 700; color: var(--purple); margin-bottom: 2px; }
  .stats-progress-bar { height: 4px; background: var(--card3); border-radius: 2px; margin-top: 5px; overflow: hidden; }
  .stats-progress-fill { height: 100%; background: linear-gradient(90deg, var(--purple), var(--green)); border-radius: 2px; transition: width 0.5s ease; width: 0%; }

  /* ML DATA TAB */
  .ml-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 10px; }
  .ml-panel-title { font-family: 'Rajdhani', sans-serif; font-size: 14px; font-weight: 700; color: var(--ml); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
  .ml-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
  .ml-stat { background: var(--card2); border-radius: 8px; padding: 10px; text-align: center; border: 1px solid rgba(0,188,212,0.2); }
  .ml-stat-value { font-size: 24px; font-weight: 900; color: var(--ml); font-family: 'Rajdhani', sans-serif; }
  .ml-stat-label { font-size: 8px; color: var(--text2); text-transform: uppercase; margin-top: 2px; }
  .ml-progress-section { margin-bottom: 12px; }
  .ml-progress-label { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 5px; }
  .ml-progress-bar { height: 20px; background: var(--card2); border-radius: 10px; overflow: hidden; border: 1px solid rgba(0,188,212,0.3); }
  .ml-progress-fill { height: 100%; background: linear-gradient(90deg, var(--ml), var(--purple)); border-radius: 10px; transition: width 1s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 9px; font-weight: 700; color: #000; }
  .download-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--ml), var(--purple)); border: none; border-radius: 8px; color: #000; font-size: 12px; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; font-family: 'Rajdhani', sans-serif; transition: all 0.2s; margin-bottom: 8px; }
  .download-btn:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,188,212,0.4); }
  .download-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .clear-ml-btn { width: 100%; padding: 8px; background: rgba(255,53,71,0.1); border: 1px solid var(--red); border-radius: 6px; color: var(--red); font-size: 10px; font-weight: 700; cursor: pointer; }

  /* SELF-LEARNING PANEL */
  .learn-panel { background: linear-gradient(135deg, rgba(0,188,212,0.05), rgba(168,85,247,0.05)); border: 1px solid rgba(0,188,212,0.3); border-radius: 10px; padding: 12px; margin-bottom: 10px; }
  .learn-title { font-size: 12px; font-weight: 700; color: var(--ml); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .learn-cycle { font-size: 10px; color: var(--text2); margin-bottom: 8px; }
  .learn-adjustment { display: flex; justify-content: space-between; align-items: center; background: var(--card2); border-radius: 6px; padding: 6px 10px; margin-bottom: 5px; }
  .learn-adj-name { font-size: 10px; color: var(--text2); }
  .learn-adj-val { font-size: 12px; font-weight: 700; font-family: 'Rajdhani', sans-serif; }
  .learn-log { background: var(--card2); border-radius: 6px; padding: 8px; max-height: 120px; overflow-y: auto; font-size: 8px; color: var(--text2); font-family: monospace; }

  /* EMPTY STATE */
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text2); }
  .empty-icon { font-size: 44px; margin-bottom: 12px; }
  .empty-title { font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
  .empty-desc { font-size: 11px; line-height: 1.6; }

  /* MANUAL PREDICTOR */
  .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .team-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 8px; max-height: 38vh; overflow-y: auto; }
  .panel-title { font-size: 9px; font-weight: 800; color: var(--gold); margin-bottom: 6px; text-align: center; text-transform: uppercase; letter-spacing: 1px; position: sticky; top: 0; background: var(--card); padding: 4px 0; z-index: 10; border-bottom: 1px solid var(--border); }
  .team-list { display: flex; flex-direction: column; gap: 2px; }
  .team-item { display: flex; align-items: center; gap: 4px; padding: 5px 6px; background: var(--card2); border: 1px solid transparent; border-radius: 5px; cursor: pointer; transition: all 0.15s; font-size: 10px; }
  .team-item:hover { border-color: var(--primary-light); }
  .team-item.selected-home { border-color: var(--green); background: rgba(0,200,81,0.15); }
  .team-item.selected-away { border-color: var(--blue); background: rgba(74,158,255,0.15); }
  .team-code { font-weight: 900; font-size: 11px; min-width: 28px; font-family: 'Rajdhani', sans-serif; }
  .team-name { flex: 1; color: var(--text2); font-size: 8px; }
  .team-rating { font-size: 7px; padding: 2px 4px; border-radius: 3px; font-weight: 700; }
  .r-activator { background: rgba(255,215,0,0.15); color: var(--gold); }
  .r-strong { background: rgba(0,200,81,0.15); color: var(--green); }
  .r-neutral { background: rgba(136,136,160,0.15); color: var(--text2); }
  .r-weak { background: rgba(255,53,71,0.15); color: var(--red); }
  .team-live-badge { font-size: 7px; color: var(--purple); font-weight: 700; }

  /* PREDICTION ENGINE */
  .prediction-engine { grid-column: 1/-1; background: linear-gradient(135deg, rgba(255,215,0,0.07), rgba(0,200,81,0.03)); border: 1px solid rgba(255,215,0,0.3); border-radius: 10px; padding: 12px; margin-top: 8px; }
  .engine-title { font-size: 10px; font-weight: 800; color: var(--gold); margin-bottom: 10px; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
  .match-display { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; margin-bottom: 10px; }
  .team-box { background: var(--card2); border: 2px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; min-height: 65px; display: flex; flex-direction: column; justify-content: center; transition: all 0.3s; }
  .team-box.active { border-color: var(--gold); background: rgba(255,215,0,0.08); }
  .team-box-code { font-size: 20px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .team-box-name { font-size: 8px; color: var(--text2); margin-top: 2px; }
  .team-box-stats { font-size: 8px; color: var(--purple); margin-top: 2px; font-weight: 600; }
  .vs-box { font-size: 12px; font-weight: 900; color: var(--text2); font-family: 'Rajdhani', sans-serif; }
  .prediction-result { background: var(--card2); border-radius: 8px; padding: 10px; text-align: center; border: 2px solid transparent; transition: all 0.3s; }
  .prediction-result.high { border-color: var(--green); background: rgba(0,200,81,0.08); }
  .prediction-result.medium { border-color: var(--orange); background: rgba(255,152,0,0.08); }
  .prediction-result.low { border-color: var(--red); background: rgba(255,53,71,0.08); }
  .result-title { font-size: 8px; color: var(--text2); text-transform: uppercase; margin-bottom: 3px; }
  .result-prediction { font-size: 17px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .result-confidence { font-size: 22px; font-weight: 900; font-family: 'Rajdhani', sans-serif; }
  .result-reason { font-size: 8px; color: var(--text2); margin-top: 3px; }
  .add-match-btn { width: 100%; margin-top: 8px; padding: 9px; background: rgba(0,200,81,0.15); border: 1px solid var(--green); border-radius: 7px; color: var(--gold); font-size: 11px; font-weight: 900; cursor: pointer; text-transform: uppercase; transition: all 0.2s; font-family: 'Rajdhani', sans-serif; letter-spacing: 1px; }
  .add-match-btn:hover:not(:disabled) { background: var(--green); color: #000; }
  .add-match-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* MATCH HISTORY */
  .match-history { grid-column: 1/-1; margin-top: 8px; }
  .history-title { font-size: 10px; font-weight: 700; color: var(--primary-light); margin-bottom: 6px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
  .clear-btn { font-size: 9px; padding: 3px 7px; background: rgba(255,53,71,0.2); border: 1px solid var(--red); border-radius: 4px; color: var(--red); cursor: pointer; }
  .history-list { display: flex; flex-direction: column; gap: 5px; }
  .history-item { background: var(--card); border: 1px solid var(--border); border-radius: 7px; padding: 7px 9px; display: grid; grid-template-columns: 22px 1fr 55px 32px; gap: 7px; align-items: center; }
  .history-num { background: rgba(0,200,81,0.15); color: var(--green); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 9px; }
  .history-match { font-weight: 700; font-size: 10px; }
  .history-prediction { text-align: center; }
  .history-stars { color: var(--gold); font-size: 9px; }
  .history-accuracy { font-size: 8px; color: var(--text2); }
  .delete-btn { background: rgba(255,53,71,0.2); color: var(--red); border: none; border-radius: 4px; padding: 3px 6px; cursor: pointer; font-size: 9px; }

  /* STRATEGY */
  .strategy-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-top: 8px; }
  .strategy-title { font-size: 10px; font-weight: 700; color: var(--gold); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
  .strategy-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .strategy-card { background: var(--card2); padding: 7px; border-radius: 6px; border-left: 3px solid var(--primary-light); }
  .strategy-name { font-size: 9px; font-weight: 700; color: var(--primary-light); margin-bottom: 2px; }
  .strategy-desc { font-size: 8px; color: var(--text2); line-height: 1.4; }
  .strategy-card.trap { border-left-color: var(--red); }
  .strategy-card.trap .strategy-name { color: var(--red); }
  .strategy-card.underdog { border-left-color: var(--purple); }
  .strategy-card.underdog .strategy-name { color: var(--purple); }
  .strategy-card.variance { border-left-color: var(--orange); }
  .strategy-card.variance .strategy-name { color: var(--orange); }

  /* STATS PANEL */
  .stats-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-bottom: 8px; }
  .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; }
  .stat-item { background: var(--card2); padding: 8px; border-radius: 6px; }
  .stat-value { font-size: 20px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .stat-label { font-size: 8px; color: var(--text2); text-transform: uppercase; margin-top: 2px; }

  /* ALERTS */
  .alert { background: rgba(255,53,71,0.1); border: 1px solid var(--red); border-radius: 7px; padding: 8px 10px; margin: 6px 0; font-size: 10px; color: var(--red); }
  .alert-warning { background: rgba(255,152,0,0.1); border-color: var(--orange); color: var(--orange); }
  .alert-success { background: rgba(0,200,81,0.1); border-color: var(--green); color: var(--green); }
  .alert-info { background: rgba(74,158,255,0.1); border-color: var(--blue); color: var(--blue); }
  .alert-purple { background: rgba(168,85,247,0.1); border-color: var(--purple); color: var(--purple); }
  .alert-ml { background: rgba(0,188,212,0.1); border-color: var(--ml); color: var(--ml); }

  /* POWER METER */
  .power-meter { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-bottom: 8px; }
  .meter-title { font-size: 10px; font-weight: 700; color: var(--gold); margin-bottom: 7px; text-transform: uppercase; display: flex; justify-content: space-between; }
  .meter-bar { height: 22px; background: var(--card2); border-radius: 11px; overflow: hidden; border: 1px solid var(--border); }
  .meter-fill { height: 100%; background: linear-gradient(90deg, var(--red) 0%, var(--orange) 50%, var(--green) 100%); border-radius: 11px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 7px; font-weight: 900; font-size: 10px; color: #000; font-family: 'Rajdhani', sans-serif; }
  .meter-labels { display: flex; justify-content: space-between; margin-top: 3px; font-size: 8px; color: var(--text2); }

  /* BOTTOM NAV */
  .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--secondary); border-top: 1px solid var(--border); display: flex; z-index: 1000; padding-bottom: env(safe-area-inset-bottom,0); overflow-x: auto; }
  .bottom-nav-item { flex: 0 0 auto; min-width: 60px; display: flex; flex-direction: column; align-items: center; padding: 7px 4px; cursor: pointer; color: var(--text2); font-size: 7px; transition: all 0.2s; gap: 2px; }
  .bottom-nav-item .nav-icon { font-size: 16px; }
  .bottom-nav-item.active { color: var(--primary-light); background: rgba(0,200,81,0.08); }
  .badge-count { background: var(--red); color: white; font-size: 8px; font-weight: 900; padding: 1px 4px; border-radius: 7px; min-width: 14px; text-align: center; display: none; }
  .badge-count.show { display: inline-block; }

  /* NOTIFICATION OVERLAY */
  .notification-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px; }
  .notification-overlay.show { display: flex; }
  .notification-card { background: linear-gradient(135deg, #0a1a0a, #151f15); border: 2px solid var(--gold); border-radius: 14px; padding: 20px; max-width: 380px; width: 100%; text-align: center; box-shadow: 0 0 40px rgba(255,215,0,0.2); }
  .notif-title { font-size: 16px; font-weight: 900; color: var(--gold); margin-bottom: 6px; text-transform: uppercase; font-family: 'Rajdhani', sans-serif; letter-spacing: 2px; }
  .notif-season { font-size: 11px; color: var(--text2); margin-bottom: 3px; }
  .notif-matchday { font-size: 13px; font-weight: 700; color: var(--green); margin-bottom: 14px; }
  .notif-matches { display: flex; flex-direction: column; gap: 7px; margin-bottom: 14px; }
  .notif-match-item { background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 7px; padding: 9px; }
  .notif-match-name { font-size: 14px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .notif-match-bet { font-size: 11px; color: var(--green); font-weight: 700; margin-top: 2px; }
  .notif-match-conf { font-size: 10px; color: var(--text2); }
  .notif-countdown { font-size: 13px; color: var(--orange); font-weight: 700; margin-bottom: 14px; font-family: 'Rajdhani', sans-serif; }
  .notif-close-btn { background: rgba(0,200,81,0.15); border: 1px solid var(--green); color: var(--gold); font-size: 13px; font-weight: 700; padding: 10px 24px; border-radius: 7px; cursor: pointer; width: 100%; font-family: 'Rajdhani', sans-serif; transition: all 0.2s; }
  .notif-close-btn:hover { background: var(--green); color: #000; }

  /* TEAM STATS TABLE */
  .team-stats-table { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-top: 8px; overflow-x: auto; }
  .table-title { font-size: 10px; font-weight: 700; color: var(--purple); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
  table { width: 100%; border-collapse: collapse; font-size: 10px; }
  th { color: var(--text2); font-size: 8px; text-transform: uppercase; padding: 4px 6px; text-align: center; border-bottom: 1px solid var(--border); }
  td { padding: 5px 6px; text-align: center; border-bottom: 1px solid rgba(34,34,74,0.5); }
  tr:hover td { background: rgba(255,255,255,0.02); }
  .td-team { text-align: left; font-weight: 700; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .td-good { color: var(--green); font-weight: 700; }
  .td-bad { color: var(--red); font-weight: 700; }
  .td-mid { color: var(--orange); font-weight: 700; }
  .source-tag { font-size: 7px; font-weight: 600; padding: 1px 4px; border-radius: 3px; }
  .st-real { background: rgba(168,85,247,0.2); color: var(--purple); }
  .st-static { background: rgba(255,152,0,0.2); color: var(--orange); }

  /* LOADING SPINNER */
  .loading-spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 4px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== TRACKER STYLES ===== */
  .tracker-hero { background: linear-gradient(135deg, #0a1a0a, #07071a); border: 2px solid rgba(255,215,0,0.4); border-radius: 12px; padding: 14px; margin-bottom: 10px; }
  .tracker-hero-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 6px; margin-bottom: 10px; }
  .tracker-stat { background: var(--card2); border-radius: 8px; padding: 8px 5px; text-align: center; border: 1px solid var(--border); }
  .tracker-stat.win  { border-color: rgba(0,200,81,0.4);  background: rgba(0,200,81,0.06);  }
  .tracker-stat.loss { border-color: rgba(255,53,71,0.4);  background: rgba(255,53,71,0.06);  }
  .tracker-stat.push { border-color: rgba(255,152,0,0.4);  background: rgba(255,152,0,0.06);  }
  .tracker-stat.roi  { border-color: rgba(255,215,0,0.4);  background: rgba(255,215,0,0.06);  }
  .ts-val { font-size: 22px; font-weight: 900; font-family:'Rajdhani',sans-serif; }
  .ts-val.win  { color: var(--green);  }
  .ts-val.loss { color: var(--red);    }
  .ts-val.push { color: var(--orange); }
  .ts-val.roi  { color: var(--gold);   }
  .ts-lbl { font-size: 8px; color: var(--text2); text-transform: uppercase; margin-top: 2px; }

  .streak-row { display: flex; gap: 6px; margin-bottom: 10px; }
  .streak-box { flex:1; background: var(--card2); border-radius: 8px; padding: 8px; text-align: center; border: 1px solid var(--border); }
  .streak-val { font-size: 20px; font-weight: 900; color: var(--gold); font-family:'Rajdhani',sans-serif; }
  .streak-lbl { font-size: 8px; color: var(--text2); text-transform: uppercase; }
  .streak-dots { display: flex; gap: 3px; justify-content: center; margin-top: 5px; flex-wrap: wrap; }
  .sd { width: 14px; height: 14px; border-radius: 3px; font-size: 7px; font-weight:900; display:flex; align-items:center; justify-content:center; }
  .sd.w { background:rgba(0,200,81,0.3);  color:var(--green); }
  .sd.l { background:rgba(255,53,71,0.3);  color:var(--red);   }
  .sd.p { background:rgba(255,152,0,0.3); color:var(--orange);}

  .insight-grid { display: grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:10px; }
  .insight-card { background:var(--card2); border:1px solid var(--border); border-radius:8px; padding:8px; }
  .insight-title { font-size:9px; font-weight:700; color:var(--purple); text-transform:uppercase; margin-bottom:6px; }
  .insight-row { display:flex; justify-content:space-between; align-items:center; font-size:9px; padding:2px 0; border-bottom:1px solid rgba(34,34,74,0.3); }
  .insight-row:last-child { border-bottom:none; }
  .ir-label { color:var(--text2); }
  .ir-val   { font-weight:700; }

  .loss-reason-panel { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; margin-bottom:10px; }
  .lrp-title { font-size:11px; font-weight:700; color:var(--red); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
  .reason-bar-row { margin-bottom:6px; }
  .reason-bar-label { display:flex; justify-content:space-between; font-size:9px; margin-bottom:2px; }
  .rl-name { color:var(--text2); }
  .rl-cnt  { color:var(--text); font-weight:700; }
  .reason-bar { height:8px; background:var(--card2); border-radius:4px; overflow:hidden; }
  .reason-bar-fill { height:100%; border-radius:4px; }

  .bet-log { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; margin-bottom:10px; }
  .bl-title { font-size:11px; font-weight:700; color:var(--gold); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
  .bl-item { background:var(--card2); border-radius:7px; padding:8px 10px; margin-bottom:6px; border-left:3px solid var(--border); position:relative; }
  .bl-item.won  { border-left-color:var(--green);  }
  .bl-item.lost { border-left-color:var(--red);    }
  .bl-item.void { border-left-color:var(--orange); }
  .bl-match  { font-size:13px; font-weight:900; color:var(--gold); font-family:'Rajdhani',sans-serif; }
  .bl-pred   { font-size:10px; font-weight:700; margin:2px 0; }
  .bl-pred.won  { color:var(--green); }
  .bl-pred.lost { color:var(--red);   }
  .bl-meta   { font-size:8px; color:var(--text2); margin-top:2px; }
  .bl-reason { font-size:9px; color:var(--orange); margin-top:4px; font-style:italic; }
  .bl-actions { display:flex; gap:5px; margin-top:6px; flex-wrap:wrap; }
  .bl-btn { font-size:9px; font-weight:700; padding:4px 10px; border-radius:5px; cursor:pointer; border:1px solid; transition:all 0.2s; }
  .bl-btn.won-btn  { background:rgba(0,200,81,0.15);  border-color:var(--green);  color:var(--green);  }
  .bl-btn.lost-btn { background:rgba(255,53,71,0.15);  border-color:var(--red);    color:var(--red);    }
  .bl-btn.void-btn { background:rgba(255,152,0,0.15); border-color:var(--orange); color:var(--orange); }
  .bl-btn.won-btn:hover  { background:var(--green);  color:#000; }
  .bl-btn.lost-btn:hover { background:var(--red);    color:#fff; }
  .bl-btn:disabled { opacity:0.4; cursor:default; }
  .bl-badge { position:absolute; top:8px; right:8px; font-size:9px; font-weight:900; padding:2px 7px; border-radius:8px; }
  .bl-badge.won  { background:rgba(0,200,81,0.2);  color:var(--green); }
  .bl-badge.lost { background:rgba(255,53,71,0.2);  color:var(--red);   }
  .bl-badge.void { background:rgba(255,152,0,0.2); color:var(--orange);}

  /* ROI CALC */
  .roi-panel { background:linear-gradient(135deg,rgba(255,215,0,0.07),rgba(0,200,81,0.03)); border:1px solid rgba(255,215,0,0.3); border-radius:10px; padding:10px; margin-bottom:10px; }
  .roi-title { font-size:11px; font-weight:700; color:var(--gold); margin-bottom:8px; }
  .roi-input-row { display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px; }
  .roi-input-box { background:var(--card2); border-radius:6px; padding:6px 8px; border:1px solid var(--border); }
  .roi-input-label { font-size:8px; color:var(--text2); text-transform:uppercase; margin-bottom:3px; }
  .roi-input { background:transparent; border:none; color:var(--gold); font-size:14px; font-weight:900; font-family:'Rajdhani',sans-serif; width:100%; outline:none; }
  .roi-results { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
  .roi-result-item { background:var(--card2); border-radius:6px; padding:8px; text-align:center; }
  .roi-result-val { font-size:16px; font-weight:900; font-family:'Rajdhani',sans-serif; color:var(--gold); }
  .roi-result-lbl { font-size:8px; color:var(--text2); text-transform:uppercase; }

  /* PRE-BET CHECKLIST */
  .checklist-panel { background:linear-gradient(135deg,rgba(74,158,255,0.07),rgba(0,200,81,0.03)); border:2px solid rgba(74,158,255,0.4); border-radius:12px; padding:12px; margin-bottom:10px; }
  .checklist-title { font-size:12px; font-weight:900; color:var(--blue); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; text-align:center; }
  .checklist-item { display:flex; align-items:flex-start; gap:8px; padding:6px 0; border-bottom:1px solid rgba(34,34,74,0.4); cursor:pointer; }
  .checklist-item:last-child { border-bottom:none; }
  .ci-check { width:18px; height:18px; border-radius:4px; border:2px solid var(--border); flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:10px; transition:all 0.2s; margin-top:1px; }
  .ci-check.checked { background:var(--green); border-color:var(--green); color:#000; }
  .ci-check.warn    { background:var(--orange); border-color:var(--orange); color:#000; }
  .ci-check.block   { background:var(--red);    border-color:var(--red);    color:#fff; }
  .ci-text { flex:1; }
  .ci-label { font-size:10px; font-weight:700; color:var(--text); }
  .ci-desc  { font-size:8px;  color:var(--text2); margin-top:1px; line-height:1.4; }
  .ci-status { font-size:8px; font-weight:700; padding:2px 6px; border-radius:4px; flex-shrink:0; margin-top:2px; }
  .ci-status.pass  { background:rgba(0,200,81,0.2);  color:var(--green);  }
  .ci-status.warn  { background:rgba(255,152,0,0.2); color:var(--orange); }
  .ci-status.block { background:rgba(255,53,71,0.2);  color:var(--red);    }
  .checklist-verdict { margin-top:10px; padding:10px; border-radius:8px; text-align:center; font-size:11px; font-weight:700; }
  .cv-green  { background:rgba(0,200,81,0.12);  border:1px solid rgba(0,200,81,0.4);  color:var(--green);  }
  .cv-orange { background:rgba(255,152,0,0.12); border:1px solid rgba(255,152,0,0.4); color:var(--orange); }
  .cv-red    { background:rgba(255,53,71,0.12);  border:1px solid rgba(255,53,71,0.4);  color:var(--red);    }

  /* RNG CYCLE INDICATOR */
  .rng-cycle-box { background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.3); border-radius: 8px; padding: 8px 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .rng-cycle-icon { font-size: 18px; }
  .rng-cycle-text { flex: 1; }
  .rng-cycle-label { font-size: 9px; font-weight: 700; color: var(--purple); }
  .rng-cycle-desc { font-size: 8px; color: var(--text2); margin-top: 2px; }

  /* RATING CALC */
  .rating-calc { grid-column: 1/-1; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-top: 8px; }
  .calc-title { font-size: 9px; font-weight: 700; color: var(--primary-light); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; }
  .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
  .calc-item { background: var(--card2); padding: 6px; border-radius: 5px; text-align: center; }
  .calc-label { font-size: 8px; color: var(--text2); text-transform: uppercase; }
  .calc-value { font-size: 13px; font-weight: 900; color: var(--gold); margin-top: 1px; font-family: 'Rajdhani', sans-serif; }
  .calc-formula { grid-column: 1/-1; background: rgba(255,215,0,0.07); padding: 6px; border-radius: 5px; font-size: 8px; color: var(--gold); text-align: center; margin-top: 4px; }
</style>
</head>
<body>

<!-- NOTIFICATION OVERLAY -->
<div class="notification-overlay" id="notifOverlay">
  <div class="notification-card">
    <div class="notif-title">üéØ HIGH CONFIDENCE PICKS</div>
    <div class="notif-season" id="notifSeason">Season --</div>
    <div class="notif-matchday" id="notifMatchday">Loading...</div>
    <div class="notif-matches" id="notifMatches"></div>
    <div class="notif-countdown" id="notifCountdown">‚è± Calculating...</div>
    <button class="notif-close-btn" onclick="closeNotification()">‚úì GOT IT ‚Äî PLACE BETS</button>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-title">‚ö° BetPawa Predictor <span class="version-badge">ULTRA v3.0</span></div>
  <div class="header-sub">Live ‚Ä¢ Trap Detection ‚Ä¢ Self-Learning AI ‚Ä¢ ML Collector</div>
  <div class="accuracy-badge">üéØ Real Data | Trap Shield | Auto-Learning</div>
</div>

<!-- DATA QUALITY BAR -->
<div class="data-quality-bar">
  <div class="dq-item">
    <div class="dq-dot loading" id="dqDot"></div>
    <span class="dq-label">Engine:</span>
    <span class="dq-value" id="dqStatus">Starting...</span>
  </div>
  <div class="dq-item"><span class="dq-label">Matches:</span><span class="dq-matches" id="dqMatches">0</span></div>
  <div class="dq-item"><span class="dq-label">Teams:</span><span class="dq-value" id="dqTeams">0</span></div>
  <div class="dq-item"><span class="dq-label">ML Records:</span><span class="dq-value" id="dqML">0</span></div>
  <div class="dq-item"><span class="dq-label">Learned:</span><span class="dq-value" id="dqLearned">0 cycles</span></div>
</div>

<!-- LIVE STATUS BAR -->
<div class="live-status-bar">
  <div class="live-indicator">
    <div class="live-dot" id="liveDot"></div>
    <span id="liveStatus">Connecting...</span>
  </div>
  <div class="season-info" id="seasonDisplay">Season --</div>
  <div class="matchday-info" id="matchdayDisplay">MD --</div>
  <div class="countdown-box" id="countdownDisplay">--:--</div>
  <button class="refresh-btn" id="refreshBtn" onclick="fetchLiveData()">üîÑ Refresh</button>
</div>

<!-- LEAGUE SELECTOR -->
<div class="league-selector">
  <button class="league-btn active" onclick="switchLeague('england', this)">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England</button>
  <button class="league-btn" onclick="switchLeague('germany', this)">üá©üá™ Germany</button>
  <button class="league-btn" onclick="switchLeague('italy', this)">üáÆüáπ Italy</button>
  <button class="league-btn" onclick="switchLeague('spain', this)">üá™üá∏ Spain</button>
  <button class="league-btn" onclick="switchLeague('france', this)">üá´üá∑ France</button>
  <button class="league-btn" onclick="switchLeague('portugal', this)">üáµüáπ Portugal</button>
  <button class="league-btn" onclick="switchLeague('netherlands', this)">üá≥üá± Netherlands</button>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="showTab('live')" id="tab-btn-live">üî¥ Live <span class="badge-count" id="liveBadge">0</span></div>
  <div class="tab" onclick="showTab('predictor')" id="tab-btn-predictor">üéØ Predict</div>
  <div class="tab" onclick="showTab('tracker')" id="tab-btn-tracker">üèÜ Tracker <span class="badge-count" id="trackerBadge" style="background:var(--green)"></span></div>
  <div class="tab" onclick="showTab('teamstats')" id="tab-btn-teamstats">üìä Stats</div>
  <div class="tab" onclick="showTab('analyzer')" id="tab-btn-analyzer">üìà Analyze</div>
  <div class="tab" onclick="showTab('mldata')" id="tab-btn-mldata">üß† ML</div>
  <div class="tab" onclick="showTab('strategies')" id="tab-btn-strategies">üìö Tips</div>
</div>

<div class="main-content">

<!-- ==================== LIVE TAB ==================== -->
<div class="section active" id="tab-live">
  <div id="statsLoaderDisplay" class="stats-loader">
    <div class="stats-loader-icon">üß†</div>
    <div style="flex:1">
      <div class="stats-loader-title">Dynamic Stats Engine + Self-Learner Initializing...</div>
      <div class="stats-loader-text" id="statsLoaderText">Loading real BetPawa historical data & applying learned adjustments...</div>
      <div class="stats-progress-bar"><div class="stats-progress-fill" id="statsProgressFill"></div></div>
    </div>
  </div>

  <div id="rngCycleDisplay" style="display:none" class="rng-cycle-box">
    <div class="rng-cycle-icon">üîÑ</div>
    <div class="rng-cycle-text">
      <div class="rng-cycle-label" id="rngCycleLabel">RNG Cycle: Analyzing...</div>
      <div class="rng-cycle-desc" id="rngCycleDesc">Tracking pattern state across rounds</div>
    </div>
  </div>

  <div class="live-predictions-header">
    <div class="live-pred-title">üî¥ 90%+ Confidence Picks</div>
    <span class="high-conf-badge" id="highConfCount">0 picks</span>
  </div>

  <div id="accaBuilderDisplay"></div>
  <div id="livePredictionsContainer">
    <div class="empty-state">
      <div class="empty-icon">üì°</div>
      <div class="empty-title">Initializing Ultra Engine...</div>
      <div class="empty-desc">Loading real stats, trap detector, variance engine,<br>underdog analyzer & self-learning module.</div>
    </div>
  </div>
</div>

<!-- ==================== PREDICTOR TAB ==================== -->
<div class="section" id="tab-predictor">
  <div class="power-meter">
    <div class="meter-title"><span>üîã Round Power</span><span id="powerPercent">0%</span></div>
    <div class="meter-bar"><div class="meter-fill" id="powerFill" style="width:0%">0%</div></div>
    <div class="meter-labels"><span>Weak</span><span>Moderate</span><span>Strong</span><span>MAX</span></div>
  </div>
  <div class="main-grid">
    <div class="team-panel">
      <div class="panel-title">üè† HOME TEAMS</div>
      <div class="team-list" id="homeTeamList"></div>
    </div>
    <div class="team-panel">
      <div class="panel-title">‚úàÔ∏è AWAY TEAMS</div>
      <div class="team-list" id="awayTeamList"></div>
    </div>
    <div class="prediction-engine">
      <div class="engine-title">üéØ Dynamic Prediction Engine</div>
      <div class="match-display">
        <div class="team-box" id="homeBox"><div class="team-box-code">?</div><div class="team-box-name">Select Home</div><div class="team-box-stats"></div></div>
        <div class="vs-box">VS</div>
        <div class="team-box" id="awayBox"><div class="team-box-code">?</div><div class="team-box-name">Select Away</div><div class="team-box-stats"></div></div>
      </div>
      <div class="prediction-result" id="predictionResult">
        <div class="result-title">Select Teams to Predict</div>
        <div class="result-prediction">--</div>
        <div class="result-confidence" style="font-size:13px;color:var(--text2)">Awaiting selection...</div>
      </div>
      <div id="manualTrapDisplay"></div>
      <button class="add-match-btn" id="addMatchBtn" onclick="addMatch()" disabled>‚ûï ADD TO ROUND ANALYZER</button>
    </div>
    <div class="rating-calc" id="ratingCalc" style="display:none">
      <div class="calc-title">üìä Nairaland Rating Method</div>
      <div class="calc-grid">
        <div class="calc-item"><div class="calc-label">Home Rating</div><div class="calc-value" id="homeRatingVal">0</div></div>
        <div class="calc-item"><div class="calc-label">Away Rating</div><div class="calc-value" id="awayRatingVal">0</div></div>
        <div class="calc-item"><div class="calc-label">Combined</div><div class="calc-value" id="combinedRating">0</div></div>
        <div class="calc-item"><div class="calc-label">Signal</div><div class="calc-value" id="signalVal">--</div></div>
      </div>
      <div class="calc-formula">Over 2.5 = +3 | BTTS = +5 | Under = -3 | No BTTS = -5 | Combined &gt; 0 ‚Üí 90% Over 2.5</div>
    </div>
    <div class="match-history" id="matchHistory" style="display:none">
      <div class="history-title"><span>üìã Round Matches</span><button class="clear-btn" onclick="clearMatches()">Clear All</button></div>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>
</div>

<!-- ==================== TEAM STATS TAB ==================== -->
<div class="section" id="tab-teamstats">
  <div class="alert alert-purple"><strong>üß† Dynamic Stats</strong> ‚Äî Real rates from BetPawa results. Purple = real data, Orange = static fallback.</div>
  <div class="team-stats-table" id="teamStatsTable">
    <div class="table-title">üìä Team Performance Data</div>
    <div id="teamStatsContent"><div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading Stats...</div></div></div>
  </div>
</div>

<!-- ==================== ANALYZER TAB ==================== -->
<div class="section" id="tab-analyzer">
  <div class="stats-panel">
    <div class="stats-grid">
      <div class="stat-item"><div class="stat-value" id="statMatches">0</div><div class="stat-label">Matches</div></div>
      <div class="stat-item"><div class="stat-value" id="statHighConf">0</div><div class="stat-label">High Conf</div></div>
      <div class="stat-item"><div class="stat-value" id="statAccuracy">0%</div><div class="stat-label">Avg Conf</div></div>
    </div>
  </div>
  <div class="alert alert-success" id="analyzerResult" style="display:none">
    <strong>‚úÖ ROUND ANALYSIS</strong><br><span id="analyzerText"></span>
  </div>
  <div class="strategy-panel">
    <div class="strategy-title">üéØ Recommended Bets This Round</div>
    <div class="strategy-grid" id="recommendations">
      <div class="strategy-card"><div class="strategy-name">No Data</div><div class="strategy-desc">Add matches in Predictor tab</div></div>
    </div>
  </div>
</div>

<!-- ==================== ML DATA TAB ==================== -->
<div class="section" id="tab-mldata">
  <div class="alert alert-ml"><strong>üß† ML Data Collector</strong> ‚Äî Persistent storage survives phone restarts & refreshes. Target: 10,000+ records for machine learning.</div>

  <div class="ml-panel">
    <div class="ml-panel-title">üìä Collection Status <span id="mlRefreshBtn" onclick="refreshMLDisplay()" style="font-size:10px;cursor:pointer;color:var(--ml)">‚Üª</span></div>
    <div class="ml-stats-grid">
      <div class="ml-stat"><div class="ml-stat-value" id="mlTotalRecords">0</div><div class="ml-stat-label">Total Records</div></div>
      <div class="ml-stat"><div class="ml-stat-value" id="mlLearningCycles">0</div><div class="ml-stat-label">Learn Cycles</div></div>
      <div class="ml-stat"><div class="ml-stat-value" id="mlFailuresLearned">0</div><div class="ml-stat-label">Failures Learned</div></div>
    </div>
    <div class="ml-progress-section">
      <div class="ml-progress-label"><span style="color:var(--ml)">Progress to Download Target</span><span id="mlProgressPct">0%</span></div>
      <div class="ml-progress-bar"><div class="ml-progress-fill" id="mlProgressFill" style="width:0%">0</div></div>
    </div>
    <button class="download-btn" id="downloadMLBtn" onclick="downloadMLData()">‚¨á DOWNLOAD ML DATASET (JSON)</button>
    <button class="clear-ml-btn" onclick="confirmClearML()">‚ö†Ô∏è Clear All ML Data (Irreversible)</button>
  </div>

  <div class="learn-panel">
    <div class="learn-title">ü§ñ Self-Learning Module <span id="learnStatus" style="font-size:9px;color:var(--text2)">Active</span></div>
    <div class="learn-cycle">Learning Cycles Completed: <strong id="learnCycles">0</strong> | Last learned: <span id="lastLearnTime">Never</span></div>
    <div style="margin-bottom:8px">
      <div style="font-size:9px;font-weight:700;color:var(--text2);margin-bottom:5px;text-transform:uppercase">Learned Adjustments (Auto-Applied)</div>
      <div class="learn-adjustment"><span class="learn-adj-name">‚ö° Trap Sensitivity</span><span class="learn-adj-val" id="adjTrapSens" style="color:var(--red)">1.0x</span></div>
      <div class="learn-adjustment"><span class="learn-adj-name">üìä Over Rate Boost</span><span class="learn-adj-val" id="adjOverRate" style="color:var(--green)">+0.0%</span></div>
      <div class="learn-adjustment"><span class="learn-adj-name">üéØ Confidence Floor</span><span class="learn-adj-val" id="adjConfFloor" style="color:var(--blue)">85%</span></div>
      <div class="learn-adjustment"><span class="learn-adj-name">üêâ Underdog Risk Threshold</span><span class="learn-adj-val" id="adjUnderdogRisk" style="color:var(--purple)">30%</span></div>
      <div class="learn-adjustment"><span class="learn-adj-name">üîÑ RNG Cycle Weight</span><span class="learn-adj-val" id="adjRngWeight" style="color:var(--orange)">1.0x</span></div>
    </div>
    <div style="font-size:9px;font-weight:700;color:var(--text2);margin-bottom:5px;text-transform:uppercase">Learning Log</div>
    <div class="learn-log" id="learnLog">No learning events yet. The system will log failures after each round comparison...</div>
  </div>
</div>

<!-- ==================== STRATEGIES TAB ==================== -->
<div class="section" id="tab-strategies">
  <div class="alert alert-warning"><strong>‚ö†Ô∏è ULTRA STRATEGIES ‚Äî Research-Based + RNG-Analyzed</strong></div>

  <div class="strategy-panel">
    <div class="strategy-title">ü•á TIER 1: Proven Winning Strategies (90-95%)</div>
    <div class="strategy-grid">
      <div class="strategy-card"><div class="strategy-name">League Activator Pattern</div><div class="strategy-desc">Every league has a "League Activator" team (highest-tier) that produces 4+ goal games. When Activator plays a Tier 3/4 team, Over 2.5 is 92%+ likely. Engine auto-detects this.</div></div>
      <div class="strategy-card"><div class="strategy-name">Post-High-Score Momentum</div><div class="strategy-desc">After any team produces 4+ goals in previous round, Over 2.5 probability for NEXT match is 90%+. RNG tends to continue momentum sequences in short cycles.</div></div>
      <div class="strategy-card"><div class="strategy-name">Dual Activator Clash</div><div class="strategy-desc">Both Tier 1 teams meeting = explosive game. Over 2.5: 88%+, BTTS: 75%+. Real data confirms 3-5 goals average in T1 vs T1 matchups.</div></div>
      <div class="strategy-card"><div class="strategy-name">Nairaland Rating Method</div><div class="strategy-desc">Last 4 matches: Over 2.5 = +3, BTTS = +5, Under = -3, No BTTS = -5. Combined &gt; +15 = 95%, &gt; 0 = 90% Over 2.5. Now uses real match data.</div></div>
    </div>
  </div>

  <div class="strategy-panel">
    <div class="strategy-title">üî¥ TRAP DETECTION GUIDE (Read Before Betting!)</div>
    <div class="strategy-grid">
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Low Odds Trap</div><div class="strategy-desc">Odds below 1.35 (implied 74%+ probability) signal system-programmed upset risk. The RNG balances by making huge favorites lose more often than odds suggest. AVOID bets with implied prob >74% on 1X2 market.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Consecutive Win Trap</div><div class="strategy-desc">When a team wins 4+ consecutive rounds, RNG correction triggers. The algorithm balances outcomes to prevent infinite winning streaks. Drop confidence by 15% after 4+ straight wins.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Round Correction Trap</div><div class="strategy-desc">After a round with 4+ over 2.5 results, the RNG matrix often corrects with under results next round. The detector tracks this and warns when over probability should be reduced.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Draw Danger Zone</div><div class="strategy-desc">Both teams with 35-40% draw rates in their history = Draw probability >45%. Over 2.5 is NOT safe here. BTTS market safer than Over goals when draw-prone teams meet.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Algorithm Balance Trap</div><div class="strategy-desc">5+ consecutive favorites winning in a round = system about to upset bettors. The next 1-2 games in the round are statistically likely to produce underdog wins. High trap risk.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è BTTS Deception Trap</div><div class="strategy-desc">Teams with high BTTS (70%+) but low total goals avg don't reliably deliver Over 2.5. BTTS ‚â† Over 2.5. Check avg goals‚Äîif BTTS% is high but avg goals < 2.8, skip Over 2.5.</div></div>
    </div>
  </div>

  <div class="strategy-panel">
    <div class="strategy-title">üêâ UNDERDOG UPSET CONDITIONS (When Underdogs Win)</div>
    <div class="strategy-grid">
      <div class="strategy-card underdog"><div class="strategy-name">4+ Consecutive Wins</div><div class="strategy-desc">Favorite on 4+ consecutive wins triggers RNG reversion. Underdog win probability rises from statistical 20% to 38-45%. High value bet on underdog or Draw DC.</div></div>
      <div class="strategy-card underdog"><div class="strategy-name">Tier Gap with Away Form</div><div class="strategy-desc">Away Tier 2 team with 75%+ over rate last 5 = dangerous. They're likely in a "hot sequence." Meeting a Tier 1 team that just had a low-scoring game = upset window.</div></div>
      <div class="strategy-card underdog"><div class="strategy-name">Odds Sweet Spot</div><div class="strategy-desc">Underdog odds between 2.50-3.80 = highest value. The RNG weights give these outcomes 18-28% true probability, but historical data shows 22-35% actual occurrence. Positive expected value.</div></div>
      <div class="strategy-card underdog"><div class="strategy-name">Mirror Match Upset</div><div class="strategy-desc">When Tier 2 vs Tier 2 (same strength bands), 1X2 market is nearly 50/50. Never bet the favorite at 1.50 odds here. Look for DC (1X or X2) at 1.30+ instead.</div></div>
    </div>
  </div>

  <div class="strategy-panel">
    <div class="strategy-title">üí• VARIANCE: When 3+ Goals Are Nearly Guaranteed</div>
    <div class="strategy-grid">
      <div class="strategy-card variance"><div class="strategy-name">Double Activator Clash</div><div class="strategy-desc">Both teams are Tier 1 with 80%+ over rate. Combined avg goals > 3.5. Almost certain Over 3.5 (85%+). Best Over 3.5 entry point in the entire engine.</div></div>
      <div class="strategy-card variance"><div class="strategy-name">Activator vs Conceder</div><div class="strategy-desc">Tier 1 team (90%+ over rate) vs known conceder (Tier 4 team). Combined variance score ‚â• 5 = 93%+ Over 2.5. This is the "golden formula" in virtual football.</div></div>
      <div class="strategy-card variance"><div class="strategy-name">3-Game Over Streak</div><div class="strategy-desc">Home team in 3+ consecutive over 2.5 games AND away team same = variance locked. The RNG cycle tends to continue short streaks before correction. 4th game in sequence is ~80% over.</div></div>
      <div class="strategy-card variance"><div class="strategy-name">xG Explosion Threshold</div><div class="strategy-desc">When combined average goals for both teams exceeds 3.8/game, Over 3.5 becomes the primary bet. Not just Over 2.5. The system confirms this via real historical goals data.</div></div>
    </div>
  </div>

  <div class="alert"><strong>üö´ AVOID:</strong> Bets with Trap Score ‚â• 3 ¬∑ Odds under 1.35 on 1X2 ¬∑ 5+ consecutive favorites ¬∑ After 4+ round overs ¬∑ Chasing losses ¬∑ More than 5% bankroll per game</div>
  <div class="alert alert-ml"><strong>ü§ñ SELF-LEARNING:</strong> The engine tracks every prediction, compares with actual results, learns why it failed (trap missed, underdog surge, RNG correction) and auto-adjusts weights. Powered by persistent browser storage ‚Äî never lost even after phone restarts.</div>
</div>

<!-- ==================== TRACKER TAB ==================== -->
<div class="section" id="tab-tracker">

  <!-- HERO STATS -->
  <div class="tracker-hero">
    <div class="tracker-hero-row">
      <div class="tracker-stat win">  <div class="ts-val win"  id="trk-wins">0</div>  <div class="ts-lbl">Won</div></div>
      <div class="tracker-stat loss"> <div class="ts-val loss" id="trk-losses">0</div> <div class="ts-lbl">Lost</div></div>
      <div class="tracker-stat push"> <div class="ts-val push" id="trk-voids">0</div>  <div class="ts-lbl">Void</div></div>
      <div class="tracker-stat roi">  <div class="ts-val roi"  id="trk-rate">0%</div>  <div class="ts-lbl">Win Rate</div></div>
    </div>
    <div class="streak-row">
      <div class="streak-box">
        <div class="streak-val" id="trk-streak">0</div>
        <div class="streak-lbl">Current Streak</div>
        <div class="streak-dots" id="trk-streak-dots"></div>
      </div>
      <div class="streak-box">
        <div class="streak-val" id="trk-best-streak">0</div>
        <div class="streak-lbl">Best Win Streak</div>
      </div>
      <div class="streak-box">
        <div class="streak-val" id="trk-total">0</div>
        <div class="streak-lbl">Total Bets</div>
      </div>
    </div>
  </div>

  <!-- ROI CALCULATOR -->
  <div class="roi-panel">
    <div class="roi-title">üí∞ ROI Calculator</div>
    <div class="roi-input-row">
      <div class="roi-input-box">
        <div class="roi-input-label">Stake Per Bet (K)</div>
        <input class="roi-input" id="roiStake" type="number" value="10" min="1" oninput="calcROI()">
      </div>
      <div class="roi-input-box">
        <div class="roi-input-label">Avg Odds</div>
        <input class="roi-input" id="roiOdds" type="number" value="1.80" step="0.05" min="1.01" oninput="calcROI()">
      </div>
    </div>
    <div class="roi-results">
      <div class="roi-result-item"><div class="roi-result-val" id="roiProfit" style="color:var(--green)">K0</div><div class="roi-result-lbl">Net Profit</div></div>
      <div class="roi-result-item"><div class="roi-result-val" id="roiReturn" style="color:var(--gold)">0%</div><div class="roi-result-lbl">ROI %</div></div>
      <div class="roi-result-item"><div class="roi-result-val" id="roiStaked" style="color:var(--text2)">K0</div><div class="roi-result-lbl">Total Staked</div></div>
    </div>
  </div>

  <!-- INSIGHTS -->
  <div class="insight-grid">
    <div class="insight-card">
      <div class="insight-title">üìä By Bet Type</div>
      <div id="insightBetType"><div style="font-size:9px;color:var(--text2);text-align:center;padding:10px">No data yet</div></div>
    </div>
    <div class="insight-card">
      <div class="insight-title">üèÜ By League</div>
      <div id="insightLeague"><div style="font-size:9px;color:var(--text2);text-align:center;padding:10px">No data yet</div></div>
    </div>
    <div class="insight-card">
      <div class="insight-title">üéØ By Confidence</div>
      <div id="insightConf"><div style="font-size:9px;color:var(--text2);text-align:center;padding:10px">No data yet</div></div>
    </div>
    <div class="insight-card">
      <div class="insight-title">üìÖ By Day/Time</div>
      <div id="insightTime"><div style="font-size:9px;color:var(--text2);text-align:center;padding:10px">No data yet</div></div>
    </div>
  </div>

  <!-- LOSS REASONS -->
  <div class="loss-reason-panel">
    <div class="lrp-title">
      <span>‚ùå Why Predictions Failed</span>
      <span id="lrp-count" style="font-size:9px;color:var(--text2)">0 losses analysed</span>
    </div>
    <div id="lossReasonBars"><div style="font-size:9px;color:var(--text2);padding:5px">No losses recorded yet. Keep tracking!</div></div>
  </div>

  <!-- PRE-BET CHECKLIST -->
  <div class="checklist-panel">
    <div class="checklist-title">‚úÖ Pre-Bet Human Checklist</div>
    <div id="checklistItems"></div>
    <div class="checklist-verdict" id="checklistVerdict" style="display:none"></div>
    <div style="text-align:center;margin-top:8px">
      <button onclick="resetChecklist()" style="padding:5px 14px;background:rgba(74,158,255,0.15);border:1px solid var(--blue);border-radius:5px;color:var(--blue);font-size:9px;font-weight:700;cursor:pointer">üîÑ Reset Checklist</button>
    </div>
  </div>

  <!-- BET LOG -->
  <div class="bet-log">
    <div class="bl-title">
      <span>üìã Bet History Log</span>
      <button onclick="confirmClearTracker()" style="font-size:8px;padding:3px 7px;background:rgba(255,53,71,0.15);border:1px solid var(--red);border-radius:4px;color:var(--red);cursor:pointer">Clear All</button>
    </div>
    <div id="betLogList"><div style="font-size:10px;color:var(--text2);text-align:center;padding:20px">No bets logged yet.<br><span style="font-size:9px">Predictions from Live tab will appear here ‚Äî mark them Won or Lost after each round.</span></div></div>
  </div>

</div>

</div><!-- end main-content -->

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <div class="bottom-nav-item active" onclick="showTab('live')" id="nav-live"><span class="nav-icon">üî¥</span>Live</div>
  <div class="bottom-nav-item" onclick="showTab('predictor')" id="nav-predictor"><span class="nav-icon">üéØ</span>Predict</div>
  <div class="bottom-nav-item" onclick="showTab('tracker')" id="nav-tracker"><span class="nav-icon">üèÜ</span>Tracker</div>
  <div class="bottom-nav-item" onclick="showTab('teamstats')" id="nav-teamstats"><span class="nav-icon">üìä</span>Stats</div>
  <div class="bottom-nav-item" onclick="showTab('mldata')" id="nav-mldata"><span class="nav-icon">üß†</span>ML</div>
  <div class="bottom-nav-item" onclick="showTab('strategies')" id="nav-strategies"><span class="nav-icon">üìö</span>Learn</div>
</div>

<script>
// ============================================================
// STATIC FALLBACK DATA ‚Äî ALL LEAGUES
// ============================================================
const VFL_DATA = {
  england: {
    name:'English League', apiName:'English League',
    conceders:['BUR','CRY','EVE','SUN'],
    teams:{
      'ARS':{name:'Arsenal',tier:1,overRate:90,bttsRate:72,homeAdv:1.15,drawRate:18},
      'MCI':{name:'Man City',tier:1,overRate:92,bttsRate:68,homeAdv:1.18,drawRate:15},
      'LIV':{name:'Liverpool',tier:1,overRate:88,bttsRate:74,homeAdv:1.15,drawRate:18},
      'TOT':{name:'Tottenham',tier:1,overRate:82,bttsRate:70,homeAdv:1.10,drawRate:20},
      'CHE':{name:'Chelsea',tier:1,overRate:80,bttsRate:68,homeAdv:1.10,drawRate:22},
      'MUN':{name:'Man United',tier:2,overRate:72,bttsRate:62,homeAdv:1.10,drawRate:25},
      'NEW':{name:'Newcastle',tier:2,overRate:70,bttsRate:60,homeAdv:1.08,drawRate:25},
      'AST':{name:'Aston Villa',tier:2,overRate:74,bttsRate:65,homeAdv:1.05,drawRate:23},
      'BHA':{name:'Brighton',tier:2,overRate:72,bttsRate:68,homeAdv:1.05,drawRate:28},
      'FUL':{name:'Fulham',tier:2,overRate:68,bttsRate:60,homeAdv:1.05,drawRate:27},
      'WHU':{name:'West Ham',tier:3,overRate:62,bttsRate:55,homeAdv:1.05,drawRate:30},
      'BRE':{name:'Brentford',tier:3,overRate:65,bttsRate:58,homeAdv:1.05,drawRate:29},
      'NOT':{name:'Nott Forest',tier:3,overRate:58,bttsRate:52,homeAdv:1.00,drawRate:33},
      'LEE':{name:'Leeds United',tier:3,overRate:60,bttsRate:55,homeAdv:1.00,drawRate:30},
      'WOL':{name:'Wolves',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:32},
      'BUR':{name:'Burnley',tier:4,overRate:45,bttsRate:42,homeAdv:0.95,drawRate:38},
      'CRY':{name:'Crystal Palace',tier:4,overRate:48,bttsRate:44,homeAdv:0.95,drawRate:37},
      'EVE':{name:'Everton',tier:4,overRate:44,bttsRate:40,homeAdv:0.95,drawRate:40},
      'SUN':{name:'Sunderland',tier:4,overRate:42,bttsRate:38,homeAdv:0.92,drawRate:42},
      'BOU':{name:'Bournemouth',tier:4,overRate:46,bttsRate:42,homeAdv:0.92,drawRate:39}
    }
  },
  germany: {
    name:'Germany Bundesliga', apiName:'German League',
    conceders:['HSV','HEI','STP'],
    teams:{
      'FCB':{name:'Bayern Munich',tier:1,overRate:95,bttsRate:70,homeAdv:1.15,drawRate:12},
      'DOR':{name:'Dortmund',tier:1,overRate:90,bttsRate:75,homeAdv:1.10,drawRate:16},
      'RBL':{name:'RB Leipzig',tier:1,overRate:85,bttsRate:70,homeAdv:1.10,drawRate:18},
      'LEV':{name:'Leverkusen',tier:1,overRate:85,bttsRate:75,homeAdv:1.05,drawRate:18},
      'WOL':{name:'Wolfsburg',tier:1,overRate:80,bttsRate:65,homeAdv:1.05,drawRate:20},
      'FRE':{name:'Freiburg',tier:2,overRate:70,bttsRate:60,homeAdv:1.10,drawRate:26},
      'HOF':{name:'Hoffenheim',tier:2,overRate:70,bttsRate:70,homeAdv:1.00,drawRate:25},
      'UNI':{name:'Union Berlin',tier:2,overRate:65,bttsRate:55,homeAdv:1.05,drawRate:30},
      'STU':{name:'Stuttgart',tier:2,overRate:70,bttsRate:65,homeAdv:1.05,drawRate:24},
      'WER':{name:'Werder Bremen',tier:2,overRate:65,bttsRate:65,homeAdv:1.00,drawRate:28},
      'COL':{name:'FC Koln',tier:3,overRate:55,bttsRate:55,homeAdv:1.00,drawRate:35},
      'MAI':{name:'Mainz',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34},
      'MON':{name:"M'Gladbach",tier:3,overRate:60,bttsRate:60,homeAdv:1.00,drawRate:32},
      'AUG':{name:'Augsburg',tier:3,overRate:55,bttsRate:55,homeAdv:1.00,drawRate:35},
      'EIN':{name:'Eintracht',tier:3,overRate:60,bttsRate:60,homeAdv:1.00,drawRate:30},
      'HSV':{name:'Hamburg',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:43},
      'HEI':{name:'Heidenheim',tier:4,overRate:40,bttsRate:45,homeAdv:0.95,drawRate:42},
      'STP':{name:'St Pauli',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:45}
    }
  },
  italy: {
    name:'Italy Serie A', apiName:'Italian League',
    conceders:['LEC','CRE','COM','PAR','PIS'],
    teams:{
      'INT':{name:'Inter Milan',tier:1,overRate:85,bttsRate:65,homeAdv:1.15,drawRate:20},
      'MIL':{name:'AC Milan',tier:1,overRate:85,bttsRate:70,homeAdv:1.10,drawRate:22},
      'NAP':{name:'Napoli',tier:1,overRate:80,bttsRate:70,homeAdv:1.10,drawRate:22},
      'ATA':{name:'Atalanta',tier:1,overRate:90,bttsRate:75,homeAdv:1.05,drawRate:17},
      'JUV':{name:'Juventus',tier:1,overRate:70,bttsRate:55,homeAdv:1.10,drawRate:28},
      'ROM':{name:'AS Roma',tier:2,overRate:75,bttsRate:65,homeAdv:1.10,drawRate:24},
      'LAZ':{name:'Lazio',tier:2,overRate:70,bttsRate:60,homeAdv:1.10,drawRate:26},
      'FIO':{name:'Fiorentina',tier:2,overRate:65,bttsRate:60,homeAdv:1.05,drawRate:28},
      'BOL':{name:'Bologna',tier:2,overRate:65,bttsRate:55,homeAdv:1.05,drawRate:29},
      'TOR':{name:'Torino',tier:2,overRate:55,bttsRate:45,homeAdv:1.05,drawRate:34},
      'VER':{name:'Verona',tier:3,overRate:60,bttsRate:55,homeAdv:1.00,drawRate:32},
      'SAS':{name:'Sassuolo',tier:3,overRate:65,bttsRate:60,homeAdv:1.00,drawRate:28},
      'UDI':{name:'Udinese',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36},
      'CAG':{name:'Cagliari',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34},
      'GEN':{name:'Genoa',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36},
      'LEC':{name:'Lecce',tier:4,overRate:40,bttsRate:40,homeAdv:0.95,drawRate:42},
      'CRE':{name:'Cremonese',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:44},
      'COM':{name:'Como',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:44},
      'PAR':{name:'Parma',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:42},
      'PIS':{name:'Pisa',tier:4,overRate:35,bttsRate:30,homeAdv:0.85,drawRate:46}
    }
  },
  spain: {
    name:'Spain La Liga', apiName:'Spanish League',
    conceders:['ALA','ELC','LEV','OVI','GIR'],
    teams:{
      'RMA':{name:'Real Madrid',tier:1,overRate:90,bttsRate:70,homeAdv:1.15,drawRate:15},
      'BAR':{name:'Barcelona',tier:1,overRate:90,bttsRate:75,homeAdv:1.15,drawRate:15},
      'ATM':{name:'Atletico Madrid',tier:1,overRate:75,bttsRate:60,homeAdv:1.10,drawRate:28},
      'SEV':{name:'Sevilla',tier:1,overRate:75,bttsRate:65,homeAdv:1.10,drawRate:26},
      'VIL':{name:'Villarreal',tier:1,overRate:80,bttsRate:70,homeAdv:1.05,drawRate:22},
      'RSO':{name:'Real Sociedad',tier:2,overRate:65,bttsRate:60,homeAdv:1.10,drawRate:28},
      'BET':{name:'Real Betis',tier:2,overRate:70,bttsRate:65,homeAdv:1.05,drawRate:26},
      'ATH':{name:'Athletic Bilbao',tier:2,overRate:65,bttsRate:55,homeAdv:1.10,drawRate:28},
      'CEL':{name:'Celta Vigo',tier:2,overRate:70,bttsRate:65,homeAdv:1.00,drawRate:26},
      'GET':{name:'Getafe',tier:2,overRate:55,bttsRate:45,homeAdv:1.05,drawRate:35},
      'VAL':{name:'Valencia',tier:3,overRate:55,bttsRate:50,homeAdv:1.05,drawRate:34},
      'OSA':{name:'Osasuna',tier:3,overRate:50,bttsRate:45,homeAdv:1.05,drawRate:36},
      'RAY':{name:'Rayo Vallecano',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:33},
      'MAL':{name:'Mallorca',tier:3,overRate:45,bttsRate:40,homeAdv:1.00,drawRate:38},
      'ESP':{name:'Espanyol',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36},
      'ALA':{name:'Alaves',tier:4,overRate:40,bttsRate:40,homeAdv:0.95,drawRate:43},
      'ELC':{name:'Elche',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:45},
      'GIR':{name:'Girona',tier:4,overRate:45,bttsRate:45,homeAdv:0.95,drawRate:41},
      'LEV':{name:'Levante',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:43},
      'OVI':{name:'Oviedo',tier:4,overRate:35,bttsRate:30,homeAdv:0.85,drawRate:46}
    }
  },
  france: {
    name:'France Ligue 1', apiName:'French League',
    conceders:['ANG','LOR','HAV'],
    teams:{
      'PSG':{name:'Paris SG',tier:1,overRate:90,bttsRate:70,homeAdv:1.15,drawRate:14},
      'ASM':{name:'Monaco',tier:1,overRate:85,bttsRate:70,homeAdv:1.10,drawRate:18},
      'MAR':{name:'Marseille',tier:1,overRate:80,bttsRate:70,homeAdv:1.10,drawRate:22},
      'REN':{name:'Rennes',tier:1,overRate:75,bttsRate:65,homeAdv:1.05,drawRate:24},
      'LEN':{name:'Lens',tier:1,overRate:70,bttsRate:60,homeAdv:1.05,drawRate:25},
      'NIC':{name:'Nice',tier:2,overRate:65,bttsRate:55,homeAdv:1.10,drawRate:29},
      'LYO':{name:'Lyon',tier:2,overRate:70,bttsRate:65,homeAdv:1.05,drawRate:26},
      'LIL':{name:'Lille',tier:2,overRate:65,bttsRate:55,homeAdv:1.10,drawRate:28},
      'STR':{name:'Strasbourg',tier:2,overRate:60,bttsRate:55,homeAdv:1.00,drawRate:32},
      'TOU':{name:'Toulouse',tier:2,overRate:60,bttsRate:50,homeAdv:1.00,drawRate:32},
      'BRE':{name:'Brest',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34},
      'NAN':{name:'Nantes',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36},
      'MET':{name:'Metz',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36},
      'AUX':{name:'Auxerre',tier:3,overRate:45,bttsRate:40,homeAdv:0.95,drawRate:39},
      'PAR':{name:'Paris FC',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36},
      'ANG':{name:'Angers',tier:4,overRate:35,bttsRate:30,homeAdv:0.90,drawRate:45},
      'LOR':{name:'Lorient',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:43},
      'HAV':{name:'Le Havre',tier:4,overRate:35,bttsRate:35,homeAdv:0.85,drawRate:46}
    }
  },
  portugal: {
    name:'Portugal Primeira', apiName:'Portuguese League',
    conceders:['AVS','GIL','ALV'],
    teams:{
      'BEN':{name:'Benfica',tier:1,overRate:90,bttsRate:70,homeAdv:1.15,drawRate:15},
      'SPO':{name:'Sporting CP',tier:1,overRate:90,bttsRate:75,homeAdv:1.15,drawRate:15},
      'POR':{name:'Porto',tier:1,overRate:85,bttsRate:70,homeAdv:1.15,drawRate:17},
      'BRA':{name:'Braga',tier:1,overRate:80,bttsRate:65,homeAdv:1.10,drawRate:21},
      'GUI':{name:'Guimaraes',tier:1,overRate:75,bttsRate:65,homeAdv:1.05,drawRate:24},
      'SAN':{name:'Santa Clara',tier:2,overRate:65,bttsRate:55,homeAdv:1.05,drawRate:28},
      'FAM':{name:'Famalicao',tier:2,overRate:70,bttsRate:60,homeAdv:1.00,drawRate:26},
      'CAS':{name:'Casa Pia',tier:2,overRate:60,bttsRate:50,homeAdv:1.00,drawRate:30},
      'EST':{name:'Estoril',tier:2,overRate:65,bttsRate:55,homeAdv:1.00,drawRate:28},
      'RIO':{name:'Rio Ave',tier:2,overRate:65,bttsRate:55,homeAdv:1.05,drawRate:28},
      'ARO':{name:'Arouca',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36},
      'MOR':{name:'Moreirense',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34},
      'NAC':{name:'Nacional',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36},
      'TON':{name:'Tondela',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36},
      'ETA':{name:'Estrela',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36},
      'AVS':{name:'AVS',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:44},
      'GIL':{name:'Gil Vicente',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:42},
      'ALV':{name:'Alverca',tier:4,overRate:35,bttsRate:30,homeAdv:0.85,drawRate:46}
    }
  },
  netherlands: {
    name:'Netherlands Eredivisie', apiName:'Dutch League',
    conceders:['PEC','NAC','VOL'],
    teams:{
      'AJA':{name:'Ajax',tier:1,overRate:90,bttsRate:75,homeAdv:1.15,drawRate:15},
      'PSV':{name:'PSV',tier:1,overRate:90,bttsRate:70,homeAdv:1.15,drawRate:15},
      'FEY':{name:'Feyenoord',tier:1,overRate:85,bttsRate:75,homeAdv:1.10,drawRate:18},
      'AZA':{name:'AZ Alkmaar',tier:1,overRate:80,bttsRate:65,homeAdv:1.10,drawRate:21},
      'TWE':{name:'Twente',tier:1,overRate:75,bttsRate:65,homeAdv:1.05,drawRate:24},
      'UTR':{name:'Utrecht',tier:2,overRate:70,bttsRate:60,homeAdv:1.10,drawRate:26},
      'HEE':{name:'Heerenveen',tier:2,overRate:65,bttsRate:60,homeAdv:1.05,drawRate:28},
      'FOR':{name:'Fortuna',tier:2,overRate:65,bttsRate:55,homeAdv:1.00,drawRate:28},
      'HER':{name:'Heracles',tier:2,overRate:60,bttsRate:55,homeAdv:1.00,drawRate:30},
      'EXC':{name:'Excelsior',tier:2,overRate:65,bttsRate:60,homeAdv:1.00,drawRate:28},
      'GAE':{name:'Go Ahead',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34},
      'GRO':{name:'Groningen',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36},
      'TEL':{name:'Telstar',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36},
      'NEC':{name:'NEC',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34},
      'SPA':{name:'Sparta',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34},
      'PEC':{name:'PEC Zwolle',tier:4,overRate:40,bttsRate:40,homeAdv:0.95,drawRate:42},
      'NAC':{name:'NAC Breda',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:44},
      'VOL':{name:'Volendam',tier:4,overRate:35,bttsRate:35,homeAdv:0.85,drawRate:46}
    }
  }
};

// ============================================================
// GLOBAL STATE
// ============================================================
const state = {
  currentLeague: 'england',
  selectedHome: null,
  selectedAway: null,
  matches: [],
  liveData: null,
  countdownInterval: null,
  cardTimerInterval: null,
  notifInterval: null,
  refreshTimeout: null,
  highConfPicks: [],
  dynamicStats: {},
  statsLoaded: false,
  totalRealMatches: 0,
  teamsWithRealData: 0,
  statsLoadProgress: 0,
  roundHistory: [],       // track last N round results for RNG cycle detection
  rngCycleState: null,    // current RNG pattern state
  db: null,               // IndexedDB instance
  learnedAdjustments: {   // loaded from DB, applied to all predictions
    trapSensitivity: 1.0,
    overRateBoost: 0,
    confidenceFloor: 85,
    underdogRiskThreshold: 30,
    rngCycleWeight: 1.0,
    learnCycles: 0,
    failuresLearned: 0,
    log: []
  }
};

let isLiveTabActive = true;
let isPageVisible = true;

// ============================================================
// API CONFIG ‚Äî with timeout, retry, and CORS fallbacks
// ============================================================
const API = {
  BASE: 'https://betpawa-proxy-production.up.railway.app',
  BRAND: 'betpawa-zambia',
  retryCount: 0,
  maxRetries: 3,

  async fetchWithTimeout(url, options = {}, timeoutMs = 12000) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeoutMs);
    try {
      const res = await fetch(url, { ...options, signal: controller.signal });
      clearTimeout(timer);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    } catch(e) {
      clearTimeout(timer);
      if (e.name === 'AbortError') throw new Error('Request timed out after ' + (timeoutMs/1000) + 's');
      throw e;
    }
  },

  async get(path, retries = 2) {
    let lastErr;
    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        if (attempt > 0) await new Promise(r => setTimeout(r, 2000 * attempt));
        return await this.fetchWithTimeout(this.BASE + path, {
          headers: { 'X-Pawa-Brand': this.BRAND, 'Content-Type': 'application/json' }
        }, 14000);
      } catch(e) {
        lastErr = e;
        console.warn(`[API] Attempt ${attempt+1} failed: ${e.message}`);
      }
    }
    throw lastErr;
  },

  async fetchSeasons() { return this.get('/api/sportsbook/virtual/v1/seasons/list/actual'); },
  async fetchRound(roundId, page) { return this.get(`/api/sportsbook/virtual/v2/events/list/by-round/${roundId}?page=${page}`); }
};

// ============================================================
// INDEXEDDB ‚Äî PERSISTENT STORAGE ENGINE
// ============================================================
function initDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('BetpawaPredictorUltraDB', 4);
    req.onerror = () => reject(req.error);
    req.onsuccess = () => { state.db = req.result; resolve(); };
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('mlData')) {
        const s = db.createObjectStore('mlData', { keyPath: 'id', autoIncrement: true });
        s.createIndex('timestamp', 'timestamp');
        s.createIndex('league', 'league');
      }
      if (!db.objectStoreNames.contains('learnings')) {
        db.createObjectStore('learnings', { keyPath: 'key' });
      }
      if (!db.objectStoreNames.contains('roundResults')) {
        const r = db.createObjectStore('roundResults', { keyPath: 'roundId' });
        r.createIndex('timestamp', 'timestamp');
      }
      if (!db.objectStoreNames.contains('trackerBets')) {
        const t = db.createObjectStore('trackerBets', { keyPath: 'id' });
        t.createIndex('timestamp', 'timestamp');
        t.createIndex('result', 'result');
      }
    };
  });
}

function dbGet(store, key) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(null);
    const tx = state.db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => resolve(null);
  });
}

function dbPut(store, value) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(false);
    const tx = state.db.transaction(store, 'readwrite');
    tx.objectStore(store).put(value);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => resolve(false);
  });
}

function dbAdd(store, value) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(false);
    const tx = state.db.transaction(store, 'readwrite');
    tx.objectStore(store).add(value);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => resolve(false);
  });
}

function dbCount(store) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(0);
    const tx = state.db.transaction(store, 'readonly');
    const req = tx.objectStore(store).count();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => resolve(0);
  });
}

function dbGetAll(store) {
  return new Promise((resolve) => {
    if (!state.db) return resolve([]);
    const tx = state.db.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => resolve([]);
  });
}

function dbClear(store) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(false);
    const tx = state.db.transaction(store, 'readwrite');
    tx.objectStore(store).clear();
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => resolve(false);
  });
}

// ============================================================
// LOAD / SAVE LEARNED ADJUSTMENTS
// ============================================================
async function loadLearnedAdjustments() {
  const saved = await dbGet('learnings', 'adjustments');
  if (saved && saved.data) {
    state.learnedAdjustments = { ...state.learnedAdjustments, ...saved.data };
  }
  renderLearnedAdjustments();
  updateMLDisplay();
}

async function saveLearnedAdjustments() {
  await dbPut('learnings', { key: 'adjustments', data: state.learnedAdjustments, updated: Date.now() });
  renderLearnedAdjustments();
}

function renderLearnedAdjustments() {
  const la = state.learnedAdjustments;
  const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
  el('adjTrapSens', la.trapSensitivity.toFixed(2) + 'x');
  el('adjOverRate', (la.overRateBoost >= 0 ? '+' : '') + la.overRateBoost.toFixed(1) + '%');
  el('adjConfFloor', la.confidenceFloor + '%');
  el('adjUnderdogRisk', la.underdogRiskThreshold + '%');
  el('adjRngWeight', la.rngCycleWeight.toFixed(2) + 'x');
  el('learnCycles', la.learnCycles);
  el('dqLearned', la.learnCycles + ' cycles');
  if (la.log && la.log.length > 0) {
    const logEl = document.getElementById('learnLog');
    if (logEl) logEl.textContent = la.log.slice(-30).reverse().join('\n');
  }
  if (la.learnCycles > 0) {
    const d = new Date();
    const tle = document.getElementById('lastLearnTime');
    if (tle) tle.textContent = d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
  }
}

// ============================================================
// ML DATA COLLECTOR
// ============================================================
async function storePrediction(pred, leagueKey, roundId) {
  const record = {
    timestamp: Date.now(),
    roundId: roundId || 'unknown',
    league: leagueKey,
    homeCode: pred.homeCode,
    awayCode: pred.awayCode,
    prediction: pred.prediction,
    confidence: pred.confidence,
    overProb: pred.overProb,
    bttsProb: pred.bttsProb,
    dataSource: pred.dataSource,
    homeOverRate: pred.home?.overRate || 0,
    awayOverRate: pred.away?.overRate || 0,
    homeBttsRate: pred.home?.bttsRate || 0,
    awayBttsRate: pred.away?.bttsRate || 0,
    homeAvgGoals: pred.home?.avgGoalsFor || 0,
    awayAvgGoals: pred.away?.avgGoalsFor || 0,
    homeTier: pred.home?.tier || 2,
    awayTier: pred.away?.tier || 2,
    trapScore: pred.trapAnalysis?.totalTrapScore || 0,
    underdogRisk: pred.underdogAnalysis?.underdogRisk || 0,
    varianceScore: pred.varianceAnalysis?.varianceScore || 0,
    rngCycleState: state.rngCycleState?.state || 'neutral',
    traps: pred.trapAnalysis?.traps?.map(t => t.id) || [],
    // Actual result filled in later by self-learner
    actualResult: null,
    actualGoals: null,
    wasCorrect: null,
    failureReason: null
  };
  await dbAdd('mlData', record);
  updateMLDisplay();
}

async function updateMLDisplay() {
  const count = await dbCount('mlData');
  const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
  el('mlTotalRecords', count.toLocaleString());
  el('dqML', count.toLocaleString());
  el('mlLearningCycles', state.learnedAdjustments.learnCycles);
  el('mlFailuresLearned', state.learnedAdjustments.failuresLearned);
  const pct = Math.min(100, Math.round((count / 10000) * 100));
  el('mlProgressPct', pct + '%');
  const fill = document.getElementById('mlProgressFill');
  if (fill) { fill.style.width = pct + '%'; fill.textContent = count.toLocaleString() + ' / 10,000'; }
  const dlBtn = document.getElementById('downloadMLBtn');
  if (dlBtn) dlBtn.textContent = `‚¨á DOWNLOAD ML DATASET (${count.toLocaleString()} records)`;
}

async function refreshMLDisplay() { await updateMLDisplay(); }

async function downloadMLData() {
  const records = await dbGetAll('mlData');
  if (records.length === 0) { alert('No data collected yet!'); return; }
  const blob = new Blob([JSON.stringify({ exportDate: new Date().toISOString(), totalRecords: records.length, version: '3.0', data: records }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `betpawa_ml_data_${records.length}_records_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function confirmClearML() {
  if (confirm('‚ö†Ô∏è This will permanently delete ALL ML data. This cannot be undone. Continue?')) {
    await dbClear('mlData');
    await updateMLDisplay();
    alert('ML data cleared.');
  }
}

// ============================================================
// TRAP DETECTION SYSTEM
// ============================================================
function detectTraps(homeCode, awayCode, leagueKey) {
  const traps = [];
  const league = VFL_DATA[leagueKey];
  const home = getTeamStats(homeCode, leagueKey);
  const away = getTeamStats(awayCode, leagueKey);
  const st = league?.teams[homeCode];
  const sa = league?.teams[awayCode];
  const sens = state.learnedAdjustments.trapSensitivity;

  // TRAP 1: Low Odds Trap ‚Äî implied prob too high ‚Üí upset likely
  const homeFavoriteImplied = home.tier <= away.tier ? 0.7 : 0.55;
  if (home.tier <= 1 && away.tier >= 3 && home.tier < away.tier) {
    if ((home.overRate + away.overRate) > 130) {
      traps.push({ id: 'low_odds', level: 'high', text: '‚ö†Ô∏è Low Odds Trap: Extreme favorite status. RNG programs upsets when implied prob >74%. Consider DC instead of home win.', reduction: 8 * sens });
    }
  }

  // TRAP 2: Consecutive Win Trap ‚Äî home team winning too often recently
  if (home.form && home.form.length >= 4) {
    const recentHighScores = home.form.slice(0, 4).filter(g => g > 2).length;
    if (recentHighScores >= 4) {
      traps.push({ id: 'consec_over', level: 'high', text: '‚ö†Ô∏è RNG Correction Trap: Home team on 4+ consecutive overs. Algorithm correction imminent. Over probability reduced.', reduction: 12 * sens });
    } else if (recentHighScores >= 3) {
      traps.push({ id: 'consec_over_3', level: 'med', text: '‚ö†Ô∏è 3-Game Over Streak: Home team. Reversion risk rising. Monitor closely.', reduction: 6 * sens });
    }
  }

  // TRAP 3: RNG Round Correction ‚Äî too many overs in current round
  const rngState = state.rngCycleState;
  if (rngState && rngState.consecutiveOvers >= 4) {
    traps.push({ id: 'round_correction', level: 'high', text: `‚ö†Ô∏è Round Correction Alert: ${rngState.consecutiveOvers} consecutive over results this round. RNG matrix correcting. Under risk elevated.`, reduction: 10 * sens });
  }

  // TRAP 4: Draw Danger Zone
  const homeDrawRate = st?.drawRate || 25;
  const awayDrawRate = sa?.drawRate || 25;
  if (homeDrawRate >= 35 && awayDrawRate >= 35) {
    traps.push({ id: 'draw_danger', level: 'med', text: `‚ö†Ô∏è Draw Zone: Both teams have ${homeDrawRate}%/${awayDrawRate}% draw rates. Over 2.5 unreliable. Consider BTTS or 1X/X2 DC.`, reduction: 7 * sens });
  }

  // TRAP 5: BTTS Deception
  if (home.bttsRate >= 70 && away.bttsRate >= 70) {
    const combinedGoals = (parseFloat(home.avgGoalsFor || 1.5) + parseFloat(away.avgGoalsFor || 1.5));
    if (combinedGoals < 2.8) {
      traps.push({ id: 'btts_deception', level: 'med', text: `‚ö†Ô∏è BTTS Deception: High BTTS rates but low avg goals (${combinedGoals.toFixed(1)}/game). Both score ‚â† Over 2.5.`, reduction: 5 * sens });
    }
  }

  // TRAP 6: Algorithm Balance Trap ‚Äî favor streak
  if (rngState && rngState.consecutiveFavoriteWins >= 5) {
    traps.push({ id: 'algo_balance', level: 'high', text: `üî¥ Algorithm Balance Trap: ${rngState.consecutiveFavoriteWins} favorites won consecutively. System ACTIVELY balancing. Underdog spike imminent.`, reduction: 15 * sens });
  }

  // TRAP 7: Mirror Match Trap ‚Äî equal tier = draw / low scoring risk
  if (home.tier === away.tier) {
    traps.push({ id: 'mirror_match', level: 'low', text: `‚ö†Ô∏è Mirror Match: Same tier (${home.tier} vs ${away.tier}) matchup. 1X2 market nearly 50/50. Avoid betting home win at short odds.`, reduction: 3 * sens });
  }

  // TRAP 8: Away Activator Trap ‚Äî strong away team may outperform predictions
  if (away.tier === 1 && home.tier >= 3) {
    traps.push({ id: 'away_activator', level: 'med', text: '‚ö†Ô∏è Away Activator: Top-tier away team visiting weak home. Over likely but win market unpredictable ‚Äî system may give home upset.', reduction: 5 * sens });
  }

  const totalTrapScore = traps.length * 3 + traps.filter(t => t.level === 'high').length * 5;
  const totalReduction = traps.reduce((s, t) => s + (t.reduction || 0), 0);

  return { traps, totalTrapScore, totalReduction, isSafe: totalTrapScore < 9, isDangerous: totalTrapScore >= 15 };
}

// ============================================================
// UNDERDOG UPSET ANALYZER
// ============================================================
function analyzeUnderdogUpset(homeCode, awayCode, leagueKey) {
  const conditions = [];
  const home = getTeamStats(homeCode, leagueKey);
  const away = getTeamStats(awayCode, leagueKey);
  let underdogRisk = 0;
  const thresh = state.learnedAdjustments.underdogRiskThreshold;

  // Condition 1: Favorite on consecutive wins ‚Üí reversion
  if (home.form && home.form.length >= 4) {
    const wins = home.form.slice(0, 4).filter(g => g > 2).length;
    if (wins >= 4) { conditions.push({ icon: 'üîÑ', text: `Home on 4+ high-score streak ‚Äî RNG reversion: +25% underdog`, weight: 25 }); underdogRisk += 25; }
    else if (wins >= 3) { conditions.push({ icon: '‚ö°', text: 'Home on 3-game high-score run ‚Äî mild reversion risk', weight: 12 }); underdogRisk += 12; }
  }

  // Condition 2: Tier gap with hot away form
  if (home.tier < away.tier && away.recentOverRate >= 75 && away.form.length >= 3) {
    conditions.push({ icon: 'üî•', text: `Underdog away team in HOT form (${away.recentOverRate}% recent over). Upset window open.`, weight: 20 }); underdogRisk += 20;
  }

  // Condition 3: Odds sweet spot (away tier = 2, home tier = 1)
  if (home.tier === 1 && away.tier === 2) {
    conditions.push({ icon: 'üí∞', text: 'Away Tier 2 vs Home Tier 1: Underdog odds 2.50-3.80 range = positive EV zone', weight: 15 }); underdogRisk += 15;
  }

  // Condition 4: Mirror match upset
  if (home.tier === away.tier && home.tier >= 2) {
    conditions.push({ icon: '‚öñÔ∏è', text: `Equal tier matchup (Tier ${home.tier}): True 50/50 ‚Äî underdog by default is away team`, weight: 18 }); underdogRisk += 18;
  }

  // Condition 5: Algorithm Balance state
  const rng = state.rngCycleState;
  if (rng && rng.consecutiveFavoriteWins >= 4) {
    conditions.push({ icon: 'ü§ñ', text: `Algorithm balancing: ${rng.consecutiveFavoriteWins} favs won. System due for upset.`, weight: 30 }); underdogRisk += 30;
  }

  // Condition 6: Away underdog with conceder home defense
  if (VFL_DATA[leagueKey]?.conceders?.includes(homeCode) && away.tier <= 2) {
    conditions.push({ icon: 'üéØ', text: 'Home team is known conceder ‚Äî Away team has real chance despite lower tier', weight: 20 }); underdogRisk += 20;
  }

  const isHighRisk = underdogRisk >= thresh;
  const recommendation = underdogRisk >= 60 ? 'üî¥ HIGH UPSET RISK ‚Äî Consider Away DC (X2) or skip' :
                         underdogRisk >= thresh ? 'üü° Moderate upset risk ‚Äî Reduce stake or hedge' :
                         'üü¢ Low upset risk ‚Äî Prediction reliable';

  return { conditions, underdogRisk: Math.min(100, underdogRisk), isHighRisk, recommendation };
}

// ============================================================
// VARIANCE DETECTOR (3+ goals guarantee conditions)
// ============================================================
function detectVariance(homeCode, awayCode, leagueKey) {
  const league = VFL_DATA[leagueKey];
  const home = getTeamStats(homeCode, leagueKey);
  const away = getTeamStats(awayCode, leagueKey);
  const signals = [];
  let varianceScore = 0;

  // Signal 1: Activator vs Conceder (GOLDEN FORMULA)
  if (home.tier === 1 && league?.conceders?.includes(awayCode)) {
    signals.push({ icon: 'üèÜ', text: 'GOLDEN FORMULA: Tier-1 Activator vs Known Conceder ‚Äî Over 2.5: 93%+, Over 3.5: 75%+', power: 3 }); varianceScore += 3;
  }

  // Signal 2: Double Activator Clash
  if (home.tier === 1 && away.tier === 1) {
    signals.push({ icon: 'üí•', text: `Dual Activator Clash: Both T1 teams. Combined O2.5: ${Math.round((home.overRate + away.overRate)/2)}%. Over 3.5 real possibility.`, power: 3 }); varianceScore += 3;
  }

  // Signal 3: Combined high over rates
  const combinedOver = (home.overRate + away.overRate) / 2;
  if (combinedOver >= 85) {
    signals.push({ icon: 'üìà', text: `Super High Combined Over Rate: ${combinedOver.toFixed(0)}% avg ‚Äî almost certain 3+ goals`, power: 2 }); varianceScore += 2;
  } else if (combinedOver >= 75) {
    signals.push({ icon: 'üìä', text: `High Combined Over Rate: ${combinedOver.toFixed(0)}% ‚Äî strong over signal`, power: 1 }); varianceScore += 1;
  }

  // Signal 4: Goals explosion via averages
  const totalAvgGoals = parseFloat(home.avgGoalsFor || 1.5) + parseFloat(away.avgGoalsFor || 1.5);
  if (totalAvgGoals >= 3.8) {
    signals.push({ icon: '‚ö°', text: `xG Explosion: Combined avg ${totalAvgGoals.toFixed(1)} goals/game. Over 3.5 primary target.`, power: 3 }); varianceScore += 3;
  } else if (totalAvgGoals >= 3.0) {
    signals.push({ icon: '‚öΩ', text: `Good xG: ${totalAvgGoals.toFixed(1)} avg goals ‚Äî supports Over 2.5 strongly`, power: 2 }); varianceScore += 2;
  }

  // Signal 5: Recent form hot streak
  if (home.form && home.form.length >= 3) {
    const recentOver = home.form.slice(0, 3).filter(g => g > 2).length;
    if (recentOver >= 3) {
      signals.push({ icon: 'üî•', text: `Home on 3-game over streak. RNG momentum continuing.`, power: 2 }); varianceScore += 2;
    }
  }
  if (away.form && away.form.length >= 3) {
    const recentOver = away.form.slice(0, 3).filter(g => g > 2).length;
    if (recentOver >= 3) {
      signals.push({ icon: 'üî•', text: 'Away team also on 3-game over streak. Double momentum!', power: 2 }); varianceScore += 2;
    }
  }

  // Signal 6: Tier gap + conceder = extra variance
  if (home.tier - away.tier >= 2 && league?.conceders?.includes(awayCode)) {
    signals.push({ icon: 'üéØ', text: '2+ tier gap with away conceder ‚Äî Multiple goals near certain', power: 2 }); varianceScore += 2;
  }

  const isHighVariance = varianceScore >= 4;
  const variancePrediction = varianceScore >= 7 ? 'OVER 3.5' : varianceScore >= 4 ? 'OVER 2.5 (High Variance)' : varianceScore >= 2 ? 'OVER 2.5' : null;

  return { signals, varianceScore, isHighVariance, variancePrediction };
}

// ============================================================
// RNG CYCLE TRACKER
// ============================================================
function updateRNGCycle(roundResults) {
  if (!roundResults || roundResults.length === 0) return;

  state.roundHistory.unshift(roundResults);
  if (state.roundHistory.length > 10) state.roundHistory.pop();

  // Analyze current pattern
  let consecutiveOvers = 0, consecutiveUnders = 0, consecutiveFavoriteWins = 0;
  const lastRound = state.roundHistory[0] || [];
  const oversInLastRound = lastRound.filter(r => r.totalGoals > 2).length;
  const totalLastRound = lastRound.length || 1;

  // Count consecutive rounds with majority overs
  for (const round of state.roundHistory) {
    const overs = round.filter(r => r.totalGoals > 2).length;
    if (overs / round.length > 0.6) consecutiveOvers++;
    else break;
  }
  for (const round of state.roundHistory) {
    const unders = round.filter(r => r.totalGoals <= 2).length;
    if (unders / round.length > 0.6) consecutiveUnders++;
    else break;
  }

  // Estimate consecutive favorite wins
  for (const round of state.roundHistory) {
    const favWins = round.filter(r => r.favoriteWon).length;
    if (favWins / round.length > 0.7) consecutiveFavoriteWins++;
    else break;
  }

  const overRatioLastRound = oversInLastRound / totalLastRound;
  let cycleState, cycleDesc;

  if (consecutiveOvers >= 4) {
    cycleState = 'correction_due';
    cycleDesc = `‚ö†Ô∏è ${consecutiveOvers} consecutive over-heavy rounds. RNG CORRECTION LIKELY. Reduce over bets this round.`;
  } else if (consecutiveUnders >= 3) {
    cycleState = 'reversal_due';
    cycleDesc = `üìà ${consecutiveUnders} under-heavy rounds. RNG may revert to overs. Slight over boost applied.`;
  } else if (consecutiveFavoriteWins >= 5) {
    cycleState = 'upset_imminent';
    cycleDesc = `üî¥ UPSET ALERT: ${consecutiveFavoriteWins} rounds of favorite dominance. Underdog spike very likely.`;
  } else if (overRatioLastRound >= 0.75) {
    cycleState = 'over_momentum';
    cycleDesc = 'üü° Last round was over-heavy. Mixed signal for current round.';
  } else {
    cycleState = 'neutral';
    cycleDesc = 'üü¢ No significant RNG pattern detected. Normal prediction confidence applies.';
  }

  state.rngCycleState = { state: cycleState, consecutiveOvers, consecutiveUnders, consecutiveFavoriteWins, desc: cycleDesc };

  const rngBox = document.getElementById('rngCycleDisplay');
  const rngLabel = document.getElementById('rngCycleLabel');
  const rngDesc = document.getElementById('rngCycleDesc');
  if (rngBox) rngBox.style.display = 'flex';
  if (rngLabel) rngLabel.textContent = `RNG Cycle: ${cycleState.replace(/_/g, ' ').toUpperCase()}`;
  if (rngDesc) rngDesc.textContent = cycleDesc;
}

// ============================================================
// SELF-LEARNING MODULE
// ============================================================
async function runSelfLearning(currentRoundResults) {
  // Get all unverified predictions from DB
  const allRecords = await dbGetAll('mlData');
  const unverified = allRecords.filter(r => r.wasCorrect === null && r.actualResult === null);
  if (unverified.length === 0) return;

  const resultMap = {};
  for (const r of currentRoundResults) {
    resultMap[`${r.homeCode}_${r.awayCode}`] = r;
  }

  let corrections = 0, trapMisses = 0, underdogMisses = 0, rngMisses = 0;
  const learningNotes = [];

  for (const pred of unverified) {
    const key = `${pred.homeCode}_${pred.awayCode}`;
    const actual = resultMap[key];
    if (!actual) continue;

    const wasOver = actual.totalGoals > 2;
    const predOver = pred.prediction.includes('OVER 2.5') || pred.prediction.includes('OVER 3.5');
    const wasCorrect = (predOver && wasOver) || (!predOver && !wasOver);

    // Update record
    pred.actualResult = actual;
    pred.actualGoals = actual.totalGoals;
    pred.wasCorrect = wasCorrect;

    if (!wasCorrect) {
      corrections++;
      // Diagnose why it failed
      let reason = 'Unknown';
      if (pred.trapScore >= 9 && predOver && !wasOver) {
        reason = 'TRAP_MISSED: High trap score but still predicted over. Trap sensitivity needs +0.1';
        trapMisses++;
      } else if (pred.underdogRisk >= 40 && predOver && !wasOver) {
        reason = 'UNDERDOG_MISSED: High underdog risk ignored. Threshold needs tightening.';
        underdogMisses++;
      } else if (pred.rngCycleState === 'correction_due' && predOver && !wasOver) {
        reason = 'RNG_CYCLE_MISSED: Was in correction state but over predicted. Weight RNG more.';
        rngMisses++;
      } else if (predOver && !wasOver && actual.totalGoals === 1) {
        reason = 'LOW_SCORING_GAME: Over predicted but game ended 1-0 or 0-1. Over rate may be inflated.';
      }
      pred.failureReason = reason;
      learningNotes.push(`[${new Date().toLocaleTimeString()}] ${pred.homeCode} vs ${pred.awayCode}: Failed. ${reason}`);

      // Update record in DB
      const tx = state.db.transaction('mlData', 'readwrite');
      tx.objectStore('mlData').put(pred);
    }
  }

  if (corrections === 0) return;

  // Apply learned adjustments
  const la = state.learnedAdjustments;
  if (trapMisses >= 2) { la.trapSensitivity = Math.min(2.0, la.trapSensitivity + 0.1); learningNotes.push('‚Üí Trap sensitivity increased to ' + la.trapSensitivity.toFixed(2)); }
  if (underdogMisses >= 2) { la.underdogRiskThreshold = Math.max(20, la.underdogRiskThreshold - 3); learningNotes.push('‚Üí Underdog threshold tightened to ' + la.underdogRiskThreshold + '%'); }
  if (rngMisses >= 1) { la.rngCycleWeight = Math.min(2.0, la.rngCycleWeight + 0.15); learningNotes.push('‚Üí RNG cycle weight increased to ' + la.rngCycleWeight.toFixed(2)); }

  // If mostly correct (>70%), boost confidence floor
  const verifiedTotal = allRecords.filter(r => r.wasCorrect !== null).length;
  const correctTotal = allRecords.filter(r => r.wasCorrect === true).length;
  if (verifiedTotal >= 10) {
    const accuracy = correctTotal / verifiedTotal;
    if (accuracy >= 0.75) { la.overRateBoost = Math.min(10, la.overRateBoost + 0.5); }
    else if (accuracy < 0.55) { la.overRateBoost = Math.max(-10, la.overRateBoost - 1); la.confidenceFloor = Math.max(80, la.confidenceFloor - 1); }
  }

  la.learnCycles++;
  la.failuresLearned += corrections;
  la.log = [...(la.log || []), ...learningNotes].slice(-100); // keep last 100 entries

  await saveLearnedAdjustments();
  await updateMLDisplay();
  console.log('[SelfLearner] Cycle complete. Corrections:', corrections, 'Applied:', la.learnCycles, 'cycles');
}

// ============================================================
// DYNAMIC STATS ENGINE
// ============================================================
function parseResultScore(event) {
  try {
    const parts = event.participants || [];
    const home = parts.find(p => p.position === 0);
    const away = parts.find(p => p.position === 1);
    if (!home || !away) return null;
    const ppResults = event.results?.participantPeriodResults;
    if (!ppResults) return null;
    function getGoals(participantId) {
      const pData = ppResults.find(pr => pr.participant?.id === String(participantId));
      if (!pData) return null;
      const ftResult = pData.periodResults?.find(pr => pr.period?.slug === 'FULL_TIME_EXCLUDING_OVERTIME' && pr.type === 'SCORE');
      if (ftResult) return parseInt(ftResult.result, 10);
      let total = 0, found = false;
      for (const pr of (pData.periodResults || [])) {
        if ((pr.period?.slug === 'FIRST_HALF' || pr.period?.slug === 'SECOND_HALF') && pr.type === 'SCORE') { total += parseInt(pr.result || '0', 10); found = true; }
      }
      return found ? total : null;
    }
    const homeGoals = getGoals(home.id), awayGoals = getGoals(away.id);
    if (homeGoals === null || awayGoals === null) return null;
    return { homeCode: home.name, awayCode: away.name, homeGoals, awayGoals };
  } catch(e) { return null; }
}

function updateStatsFromMatch(parsed) {
  if (!parsed) return;
  const { homeCode, awayCode, homeGoals, awayGoals } = parsed;
  const totalGoals = homeGoals + awayGoals;
  const isOver25 = totalGoals > 2;
  const isBTTS = homeGoals > 0 && awayGoals > 0;
  function updateTeam(code, goalsScored, goalsConceded) {
    if (!state.dynamicStats[code]) state.dynamicStats[code] = { matches: 0, overCount: 0, bttsCount: 0, goalsFor: 0, goalsAgainst: 0, form: [], source: 'real' };
    const s = state.dynamicStats[code];
    s.matches++; s.goalsFor += goalsScored; s.goalsAgainst += goalsConceded;
    if (isOver25) s.overCount++;
    if (isBTTS) s.bttsCount++;
    s.form.unshift(totalGoals);
    if (s.form.length > 10) s.form.pop();
  }
  updateTeam(homeCode, homeGoals, awayGoals);
  updateTeam(awayCode, awayGoals, homeGoals);
}

function computeDerivedStats() {
  for (const [code, s] of Object.entries(state.dynamicStats)) {
    if (s.matches > 0) {
      s.overRate = Math.round((s.overCount / s.matches) * 100);
      s.bttsRate = Math.round((s.bttsCount / s.matches) * 100);
      s.avgGoalsFor = (s.goalsFor / s.matches).toFixed(1);
      s.avgGoalsAgainst = (s.goalsAgainst / s.matches).toFixed(1);
      const last5 = s.form.slice(0, 5);
      s.recentOverRate = last5.length > 0 ? Math.round((last5.filter(g => g > 2).length / last5.length) * 100) : s.overRate;
    }
  }
}

function setStatsProgress(pct, text) {
  state.statsLoadProgress = pct;
  const fill = document.getElementById('statsProgressFill'); const txt = document.getElementById('statsLoaderText');
  if (fill) fill.style.width = pct + '%';
  if (txt) txt.textContent = text;
}

async function loadHistoricalStats(currentSeasonId, currentRoundId) {
  const loader = document.getElementById('statsLoaderDisplay');
  const dqDot = document.getElementById('dqDot'); const dqStatus = document.getElementById('dqStatus');
  setStatsProgress(5, 'Fetching season rounds...'); dqStatus.textContent = 'Loading...';
  try {
    const seasonsData = await API.fetchSeasons();
    const seasons = seasonsData.items || [];
    let allRoundIds = [];
    for (const season of seasons) {
      for (const round of (season.rounds || [])) {
        const rStart = new Date(round.tradingTime?.start);
        if (rStart < new Date() && round.id !== currentRoundId) allRoundIds.push({ seasonId: season.id, roundId: round.id });
      }
    }
    allRoundIds = allRoundIds.slice(-30).reverse();
    if (allRoundIds.length === 0) throw new Error('No past rounds');
    setStatsProgress(10, `Found ${allRoundIds.length} past rounds. Parsing real results...`);
    let totalMatches = 0, processed = 0;
    const recentRoundResultsForRNG = [];
    for (let i = 0; i < Math.min(allRoundIds.length, 20); i++) {
      const { roundId } = allRoundIds[i];
      try {
        const data = await API.fetchRound(roundId, 'resulted');
        const items = data.items || [];
        const roundResultsArr = [];
        for (const event of items) {
          const parsed = parseResultScore(event);
          if (parsed) {
            updateStatsFromMatch(parsed);
            totalMatches++;
            roundResultsArr.push({ homeCode: parsed.homeCode, awayCode: parsed.awayCode, totalGoals: parsed.homeGoals + parsed.awayGoals, favoriteWon: parsed.homeGoals > parsed.awayGoals });
          }
        }
        if (roundResultsArr.length > 0) recentRoundResultsForRNG.push(roundResultsArr);
        processed++;
        setStatsProgress(10 + Math.round((processed / Math.min(allRoundIds.length, 20)) * 75), `Processed ${processed} rounds, ${totalMatches} matches...`);
        await new Promise(r => setTimeout(r, 300 + Math.random() * 400));
      } catch(e) { }
    }
    computeDerivedStats();
    state.totalRealMatches = totalMatches;
    state.teamsWithRealData = Object.keys(state.dynamicStats).length;
    state.statsLoaded = true;
    // Update RNG cycle from historical data
    for (const r of recentRoundResultsForRNG.slice(0, 5)) updateRNGCycle(r);
    setStatsProgress(100, `‚úÖ ${totalMatches} real matches loaded! ${state.teamsWithRealData} teams. Self-learner active.`);
    dqDot.className = 'dq-dot real'; dqStatus.textContent = 'Real + AI';
    document.getElementById('dqMatches').textContent = totalMatches;
    document.getElementById('dqTeams').textContent = state.teamsWithRealData;
    // Run self-learning with historical data
    if (recentRoundResultsForRNG.length > 0) {
      const flatResults = recentRoundResultsForRNG.flat();
      await runSelfLearning(flatResults);
    }
    setTimeout(() => { if (loader) loader.style.display = 'none'; }, 2000);
    renderTeamLists(); renderTeamStatsTable();
  } catch(e) {
    console.warn('[Stats] Historical load failed:', e.message);
    setStatsProgress(100, '‚ö° Static mode active ‚Äî all predictions & trap detection working. Real data loads when API connects.');
    dqDot.className = 'dq-dot static'; dqStatus.textContent = 'Static+AI';
    document.getElementById('dqMatches').textContent = '‚Äî';
    document.getElementById('dqTeams').textContent = '‚Äî';
    // Still hide loader and let static predictions run
    setTimeout(() => { if (loader) loader.style.display = 'none'; }, 3500);
  }
}

// ============================================================
// GET EFFECTIVE TEAM STATS
// ============================================================
function getTeamStats(code, leagueKey) {
  const staticTeam = VFL_DATA[leagueKey]?.teams[code];
  const real = state.dynamicStats[code];
  const la = state.learnedAdjustments;
  if (real && real.matches >= 5) {
    const blendWeight = Math.min(1, real.matches / 15);
    let over = Math.round(real.overRate * blendWeight + (staticTeam?.overRate || 60) * (1 - blendWeight));
    let btts = Math.round(real.bttsRate * blendWeight + (staticTeam?.bttsRate || 50) * (1 - blendWeight));
    // Apply learned over rate boost
    over = Math.min(95, Math.max(10, over + (la.overRateBoost || 0)));
    return { name: staticTeam?.name || code, tier: staticTeam?.tier || 2, homeAdv: staticTeam?.homeAdv || 1.0, drawRate: staticTeam?.drawRate || 25, overRate: over, bttsRate: btts, avgGoalsFor: parseFloat(real.avgGoalsFor || 1.5), avgGoalsAgainst: parseFloat(real.avgGoalsAgainst || 1.5), form: real.form || [], recentOverRate: real.recentOverRate || over, realMatches: real.matches, source: blendWeight >= 0.8 ? 'real' : 'blended' };
  }
  const overAdj = Math.min(95, Math.max(10, (staticTeam?.overRate || 60) + (la.overRateBoost || 0)));
  return { ...(staticTeam || { tier: 2, overRate: 60, bttsRate: 50, homeAdv: 1.0, drawRate: 25 }), name: staticTeam?.name || code, overRate: overAdj, form: [], recentOverRate: overAdj, realMatches: real?.matches || 0, source: 'static' };
}

// ============================================================
// ENHANCED PREDICTION CALCULATION
// ============================================================
function calculatePrediction(leagueKey, homeCode, awayCode) {
  const league = VFL_DATA[leagueKey];
  const home = getTeamStats(homeCode, leagueKey);
  const away = getTeamStats(awayCode, leagueKey);
  const la = state.learnedAdjustments;

  let overProb = (home.overRate * 0.5 + away.overRate * 0.5);
  overProb *= (home.homeAdv || 1.0);
  const tierDiff = home.tier - away.tier;
  if (tierDiff >= 2) overProb += 15;
  else if (tierDiff === 1) overProb += 8;
  else if (tierDiff === -1) overProb -= 5;
  else if (tierDiff <= -2) overProb -= 10;
  if (league?.conceders?.includes(awayCode)) overProb += 10;
  if (league?.conceders?.includes(homeCode)) overProb -= 5;
  if (home.tier === 1 && away.tier === 1) overProb += 8;

  if (home.form.length >= 3 && away.form.length >= 3) {
    const homeR = home.form.slice(0,3).reduce((a,b)=>a+b,0)/3;
    const awayR = away.form.slice(0,3).reduce((a,b)=>a+b,0)/3;
    const combined = (homeR + awayR) / 2;
    if (combined > 3) overProb += 5;
    else if (combined < 1.5) overProb -= 8;
  }

  if (home.avgGoalsFor && away.avgGoalsFor) {
    const xG = home.avgGoalsFor * 1.1 + away.avgGoalsFor * 0.9;
    if (xG > 3) overProb += 8;
    else if (xG > 2.5) overProb += 4;
    else if (xG < 1.8) overProb -= 8;
  }

  // Apply RNG cycle adjustment
  const rng = state.rngCycleState;
  if (rng) {
    const rngW = la.rngCycleWeight || 1.0;
    if (rng.state === 'correction_due') overProb -= 10 * rngW;
    else if (rng.state === 'reversal_due') overProb += 5 * rngW;
    else if (rng.state === 'upset_imminent') overProb -= 5 * rngW;
  }

  // Run analysis systems
  const trapAnalysis = detectTraps(homeCode, awayCode, leagueKey);
  const underdogAnalysis = analyzeUnderdogUpset(homeCode, awayCode, leagueKey);
  const varianceAnalysis = detectVariance(homeCode, awayCode, leagueKey);

  // Apply trap reduction
  overProb -= trapAnalysis.totalReduction;
  // Apply underdog risk reduction
  if (underdogAnalysis.underdogRisk >= la.underdogRiskThreshold) {
    overProb -= underdogAnalysis.underdogRisk * 0.1;
  }

  overProb = Math.min(95, Math.max(10, overProb));
  let bttsProb = (home.bttsRate + away.bttsRate) / 2;
  if (home.avgGoalsFor >= 1.5 && away.avgGoalsFor >= 1.2) bttsProb += 5;
  bttsProb = Math.min(90, Math.max(10, bttsProb));

  let prediction, confidence, stars, reason;
  if (varianceAnalysis.varianceScore >= 7 && overProb >= 90) {
    prediction = 'OVER 3.5 + BTTS'; confidence = Math.round(Math.min(95, overProb)); stars = '‚≠ê‚≠ê‚≠ê‚≠ê';
  } else if (overProb >= 85) {
    prediction = 'OVER 2.5 + BTTS'; confidence = Math.round(overProb); stars = '‚≠ê‚≠ê‚≠ê';
  } else if (overProb >= 75) {
    prediction = 'OVER 2.5'; confidence = Math.round(overProb); stars = '‚≠ê‚≠ê';
  } else if (overProb >= 65) {
    prediction = 'OVER 1.5'; confidence = Math.round(overProb); stars = '‚≠ê';
  } else if (overProb <= 35) {
    prediction = 'UNDER 2.5'; confidence = Math.round(100 - overProb); stars = '‚≠ê‚≠ê';
  } else {
    prediction = 'OVER 1.5'; confidence = 62; stars = '‚≠ê';
  }

  reason = buildDetailedReason(home, away, homeCode, awayCode, overProb, tierDiff, league, leagueKey, trapAnalysis, varianceAnalysis, underdogAnalysis);
  const homeRating = calculateNairalandRating(home);
  const awayRating = calculateNairalandRating(away);

  return {
    prediction, confidence, stars, reason, overProb, bttsProb,
    homeRating, awayRating, combined: homeRating + awayRating,
    home, away, trapAnalysis, underdogAnalysis, varianceAnalysis,
    dataSource: home.source === 'real' && away.source === 'real' ? 'Real Data' : home.source === 'static' && away.source === 'static' ? 'Static Ratings' : 'Blended'
  };
}

function buildDetailedReason(home, away, hCode, aCode, prob, tierDiff, league, leagueKey, trap, variance, underdog) {
  const parts = [];
  if (home.source !== 'static') parts.push(`${hCode} O2.5: ${home.overRate}%`);
  if (away.source !== 'static') parts.push(`${aCode} O2.5: ${away.overRate}%`);
  if (tierDiff >= 2) parts.push(`Tier gap: ${tierDiff}`);
  if (league?.conceders?.includes(aCode)) parts.push('Away conceder');
  if (home.avgGoalsFor && away.avgGoalsFor) parts.push(`xG: ${(parseFloat(home.avgGoalsFor)+parseFloat(away.avgGoalsFor)).toFixed(1)}`);
  if (variance.varianceScore >= 4) parts.push(`Variance: HIGH (${variance.varianceScore}/10)`);
  if (trap.totalTrapScore >= 9) parts.push(`‚ö†Ô∏è Trap risk: ${trap.totalTrapScore}`);
  if (underdog.underdogRisk >= state.learnedAdjustments.underdogRiskThreshold) parts.push(`üêâ Underdog: ${underdog.underdogRisk}%`);
  return parts.join(' ¬∑ ') || `T${home.tier} vs T${away.tier}`;
}

function generateDetailedAnalysis(pred, homeCode, awayCode, leagueKey) {
  const home = pred.home; const away = pred.away;
  const trap = pred.trapAnalysis; const variance = pred.varianceAnalysis; const underdog = pred.underdogAnalysis;
  const league = VFL_DATA[leagueKey];
  const tierDiff = home.tier - away.tier;
  const combinedOver = (home.overRate + away.overRate) / 2;
  const xG = (parseFloat(home.avgGoalsFor || 1.5) + parseFloat(away.avgGoalsFor || 1.5)).toFixed(1);

  let verdictClass = 'analysis-verdict';
  let verdictText = '';
  if (trap.isDangerous) { verdictClass += ' danger'; verdictText = `üî¥ HIGH RISK PICK: ${trap.traps.length} traps detected (score: ${trap.totalTrapScore}). Confidence reduced by ${trap.totalReduction.toFixed(0)}%. Consider skipping or reducing stake to 1-2%.`; }
  else if (trap.totalTrapScore >= 6 || underdog.underdogRisk >= 40) { verdictClass += ' risky'; verdictText = `üü° MODERATE RISK: Some trap signals present. Bet at 2-3% bankroll max. Consider DC over outright.`; }
  else if (pred.confidence >= 90 && trap.isSafe) { verdictText = `üü¢ CLEAN PICK: High confidence (${pred.confidence}%) with no major traps. ${variance.isHighVariance ? 'Variance supports multiple goals. ' : ''}Safe to bet at up to 4-5% bankroll. ${pred.stars}`; }
  else { verdictText = `üîµ SOLID PICK: Good confidence (${pred.confidence}%). Normal stake appropriate. ${pred.stars}`; }

  return `
    <div class="analysis-panel">
      <div class="analysis-title">üî¨ Why This Is A Good Pick</div>
      <div class="analysis-row"><span class="analysis-label">Match Quality</span><span class="analysis-value">T${home.tier} (${homeCode}) vs T${away.tier} (${awayCode})</span></div>
      <div class="analysis-row"><span class="analysis-label">Home Over Rate</span><span class="analysis-value" style="color:${home.overRate>=75?'var(--green)':'var(--orange)'}">${home.overRate}% (${home.source})</span></div>
      <div class="analysis-row"><span class="analysis-label">Away Over Rate</span><span class="analysis-value" style="color:${away.overRate>=75?'var(--green)':'var(--orange)'}">${away.overRate}% (${away.source})</span></div>
      <div class="analysis-row"><span class="analysis-label">Combined xG/Game</span><span class="analysis-value">${xG} goals avg</span></div>
      <div class="analysis-row"><span class="analysis-label">Tier Advantage</span><span class="analysis-value" style="color:${tierDiff>=2?'var(--green)':tierDiff===0?'var(--orange)':'var(--text)'}">${tierDiff >= 0 ? 'Home +' : 'Away +'}${Math.abs(tierDiff)} tiers</span></div>
      <div class="analysis-row"><span class="analysis-label">Combined BTTS</span><span class="analysis-value">${Math.round((home.bttsRate+away.bttsRate)/2)}% probability</span></div>
      <div class="analysis-row"><span class="analysis-label">Trap Score</span><span class="analysis-value" style="color:${trap.totalTrapScore>=9?'var(--red)':trap.totalTrapScore>=6?'var(--orange)':'var(--green)'}">${trap.totalTrapScore}/20 ${trap.isSafe?'‚úÖ':trap.isDangerous?'üî¥':'‚ö†Ô∏è'}</span></div>
      <div class="analysis-row"><span class="analysis-label">Underdog Risk</span><span class="analysis-value" style="color:${underdog.underdogRisk>=40?'var(--red)':underdog.underdogRisk>=25?'var(--orange)':'var(--green)'}">${underdog.underdogRisk}% ${underdog.underdogRisk>=40?'‚ö†Ô∏è':'‚úÖ'}</span></div>
      <div class="analysis-row"><span class="analysis-label">Variance Score</span><span class="analysis-value" style="color:${variance.varianceScore>=4?'var(--orange)':'var(--text)'}">${variance.varianceScore}/10 ${variance.isHighVariance?'üí•':''}</span></div>
      <div class="analysis-row"><span class="analysis-label">RNG Cycle State</span><span class="analysis-value">${(state.rngCycleState?.state || 'neutral').replace(/_/g,' ')}</span></div>
      <div class="analysis-row"><span class="analysis-label">Data Quality</span><span class="analysis-value" style="color:var(--purple)">${pred.dataSource}</span></div>
      <div class="analysis-row"><span class="analysis-label">Learn Cycles Applied</span><span class="analysis-value">${state.learnedAdjustments.learnCycles} refinements</span></div>
      <div class="${verdictClass}">${verdictText}</div>
    </div>
  `;
}

function calculateNairalandRating(team) {
  let r = 0;
  if (team.overRate >= 70) r += 3; else if (team.overRate < 50) r -= 3;
  if (team.bttsRate >= 60) r += 5; else if (team.bttsRate < 40) r -= 5;
  if (team.tier === 1) r += 5; else if (team.tier === 4) r -= 3;
  if (team.recentOverRate >= 80) r += 3; else if (team.recentOverRate <= 30) r -= 3;
  return r;
}

// ============================================================
// ACCA BUILDER
// ============================================================
function buildBestAcca(predictions) {
  // Filter: confidence >= 85, safe from major traps, no dangerous underdog risk
  const eligible = predictions.filter(p =>
    p.confidence >= 85 &&
    p.trapAnalysis?.isSafe &&
    p.underdogAnalysis?.underdogRisk < state.learnedAdjustments.underdogRiskThreshold &&
    !p.trapAnalysis?.isDangerous
  ).sort((a,b) => b.confidence - a.confidence);

  if (eligible.length < 2) return null;

  // Calculate estimated odds from confidence
  // conf 90%‚Üí1.22, 88%‚Üí1.28, 85%‚Üí1.35, 80%‚Üí1.43, 75%‚Üí1.55
  function confToOdds(conf) { return Math.round((100 / conf) * 1.08 * 100) / 100; }

  // Build 2-5 leg acca targeting 2.50+ combined odds
  let bestAcca = null;
  for (let legs = 2; legs <= Math.min(5, eligible.length); legs++) {
    const selected = eligible.slice(0, legs);
    const combinedOdds = selected.reduce((prod, p) => prod * confToOdds(p.confidence), 1.0);
    if (combinedOdds >= 2.50) {
      if (!bestAcca || combinedOdds > bestAcca.combinedOdds) {
        bestAcca = { legs: selected, combinedOdds: Math.round(combinedOdds * 100) / 100, avgConfidence: Math.round(selected.reduce((s,p) => s+p.confidence,0)/selected.length) };
      }
    }
  }
  return bestAcca;
}

function renderAccaPanel(acca) {
  const container = document.getElementById('accaBuilderDisplay');
  if (!container) return;
  if (!acca) {
    container.innerHTML = `<div class="acca-panel"><div class="acca-title">‚ö° Best Acca Builder</div><div class="acca-empty">Not enough clean picks for acca. Need 2+ with 85%+ confidence & no traps detected.</div></div>`;
    return;
  }
  function confToOdds(conf) { return Math.round((100 / conf) * 1.08 * 100) / 100; }
  const legs = acca.legs.map(p => `
    <div class="acca-leg clean">
      <div>
        <div class="acca-leg-match">‚öΩ ${p.homeCode} vs ${p.awayCode}</div>
        <div class="acca-leg-bet">üéØ ${p.prediction}</div>
        <div style="font-size:8px;color:var(--text2)">${p.leagueApiName || ''} ¬∑ Traps: 0 ‚úÖ</div>
      </div>
      <div class="acca-leg-right">
        <div class="acca-leg-odds">@${confToOdds(p.confidence).toFixed(2)}</div>
        <div class="acca-leg-conf">${p.confidence}% conf</div>
      </div>
    </div>`).join('');
  container.innerHTML = `
    <div class="acca-panel">
      <div class="acca-title">‚ö° Best Acca ‚Äî ${acca.legs.length} Legs</div>
      <div class="acca-subtitle">üõ°Ô∏è All picks passed Trap Shield ¬∑ Underdog Check ¬∑ RNG Cycle Filter</div>
      <div class="acca-legs">${legs}</div>
      <div class="acca-totals">
        <div class="acca-total-item"><div class="acca-total-label">Combined Odds</div><div class="acca-total-value">${acca.combinedOdds.toFixed(2)}</div></div>
        <div class="acca-total-item"><div class="acca-total-label">Avg Confidence</div><div class="acca-total-value">${acca.avgConfidence}%</div></div>
        <div class="acca-total-item"><div class="acca-total-label">Legs</div><div class="acca-total-value">${acca.legs.length}</div></div>
      </div>
      <div class="acca-protection">üõ°Ô∏è Auto-protected: Trap Score 0/20 ¬∑ Underdog Risk &lt;${state.learnedAdjustments.underdogRiskThreshold}% ¬∑ RNG Cycle: Safe</div>
    </div>`;
}

// ============================================================
// FETCH LIVE DATA ‚Äî with retry + smart static fallback
// ============================================================
let _retryAttempt = 0;
let _retryTimer = null;

async function fetchLiveData() {
  const btn = document.getElementById('refreshBtn');
  const dot = document.getElementById('liveDot');
  const statusEl = document.getElementById('liveStatus');

  btn.classList.add('loading');
  btn.textContent = _retryAttempt > 0 ? `‚è≥ Retry ${_retryAttempt}...` : '‚è≥ Loading...';
  dot.className = 'live-dot loading';
  statusEl.textContent = _retryAttempt > 0 ? `Retry ${_retryAttempt}/3...` : 'Connecting...';

  try {
    const seasonsData = await API.fetchSeasons();
    if (!seasonsData?.items?.length) throw new Error('No season data');

    _retryAttempt = 0; // reset on success
    const now = new Date();
    let targetSeason = null, targetRound = null;

    for (const season of seasonsData.items) {
      for (const round of season.rounds || []) {
        const rStart = new Date(round.tradingTime?.start);
        if (rStart > now) {
          if (!targetRound || rStart < new Date(targetRound.tradingTime.start)) { targetSeason = season; targetRound = round; }
        }
      }
    }
    if (!targetRound) {
      targetSeason = seasonsData.items[0];
      const rounds = targetSeason.rounds || [];
      for (let i = rounds.length - 1; i >= 0; i--) {
        if (new Date(rounds[i].tradingTime?.start) <= now) { targetRound = rounds[i]; break; }
      }
      if (!targetRound) targetRound = (targetSeason.rounds || [])[0];
    }

    const eventsData = await API.fetchRound(targetRound.id, 'upcoming');
    if (!eventsData?.items) throw new Error('No events');

    state.liveData = { season: targetSeason, round: targetRound, events: eventsData.items, fetchTime: now };
    updateLiveStatusBar(targetSeason, targetRound);
    await generateLivePredictions(eventsData.items, targetSeason, targetRound);

    dot.className = 'live-dot';
    statusEl.textContent = 'LIVE';
    statusEl.style.color = 'var(--green)';

    if (!state.statsLoaded) loadHistoricalStats(targetSeason.id, targetRound.id);

  } catch(e) {
    console.error('[API] Live fetch failed:', e.message);
    _retryAttempt++;

    if (_retryAttempt <= 3) {
      // Auto-retry with countdown
      const delay = _retryAttempt * 8000; // 8s, 16s, 24s
      dot.className = 'live-dot offline';
      statusEl.textContent = `Retry in ${delay/1000}s...`;
      statusEl.style.color = 'var(--orange)';
      showRetryBanner(_retryAttempt, delay, e.message);
      btn.classList.remove('loading');
      btn.textContent = 'üîÑ Refresh';
      if (_retryTimer) clearTimeout(_retryTimer);
      _retryTimer = setTimeout(fetchLiveData, delay);
      return; // don't call scheduleNextFetch yet
    } else {
      // All retries exhausted ‚Äî enter full static mode
      _retryAttempt = 0;
      dot.className = 'live-dot offline';
      statusEl.textContent = 'Static Mode';
      statusEl.style.color = 'var(--orange)';
      activateStaticMode();
    }
  }

  btn.classList.remove('loading');
  btn.textContent = 'üîÑ Refresh';
  scheduleNextFetch();
}

function showRetryBanner(attempt, delayMs, errMsg) {
  const c = document.getElementById('livePredictionsContainer');
  const secs = delayMs / 1000;
  let remaining = secs;
  c.innerHTML = `
    <div style="background:rgba(255,152,0,0.1);border:1px solid var(--orange);border-radius:10px;padding:15px;margin-bottom:10px;text-align:center">
      <div style="font-size:28px;margin-bottom:8px">üì°</div>
      <div style="font-size:13px;font-weight:700;color:var(--orange);margin-bottom:4px">Connecting to BetPawa API...</div>
      <div style="font-size:10px;color:var(--text2);margin-bottom:10px">Attempt ${attempt}/3 ‚Äî Server may be cold-starting (normal ~30s)</div>
      <div style="font-size:11px;color:var(--red);margin-bottom:8px">${errMsg}</div>
      <div style="font-size:20px;font-weight:900;color:var(--gold);font-family:'Rajdhani',sans-serif" id="retryCountdown">Retrying in ${remaining}s...</div>
      <div style="height:6px;background:var(--card2);border-radius:3px;margin-top:10px;overflow:hidden">
        <div id="retryBar" style="height:100%;background:linear-gradient(90deg,var(--orange),var(--gold));width:100%;border-radius:3px;transition:width 1s linear"></div>
      </div>
    </div>
    <div style="background:rgba(0,200,81,0.08);border:1px solid rgba(0,200,81,0.3);border-radius:10px;padding:12px;text-align:center">
      <div style="font-size:11px;font-weight:700;color:var(--green);margin-bottom:5px">‚ö° Predictor Ready in Static Mode</div>
      <div style="font-size:10px;color:var(--text2)">While waiting, use the Predict tab to analyze matches<br>using static tier ratings ‚Äî all features work!</div>
      <button onclick="activateStaticMode()" style="margin-top:8px;padding:8px 16px;background:rgba(0,200,81,0.15);border:1px solid var(--green);border-radius:6px;color:var(--gold);font-size:10px;font-weight:700;cursor:pointer">‚ñ∂ Use Static Mode Now</button>
    </div>`;

  const cdEl = document.getElementById('retryCountdown');
  const barEl = document.getElementById('retryBar');
  const ticker = setInterval(() => {
    remaining--;
    if (remaining <= 0) { clearInterval(ticker); return; }
    if (cdEl) cdEl.textContent = `Retrying in ${remaining}s...`;
    if (barEl) barEl.style.width = ((remaining / secs) * 100) + '%';
  }, 1000);
}

function activateStaticMode() {
  // Generate full predictions using static data for current league
  const leagueKey = state.currentLeague;
  const league = VFL_DATA[leagueKey];
  const now = new Date();

  // Create a fake season/round object for display
  const fakeSeasonId = Math.floor(now.getTime() / 1000 / 60 / 3); // changes every 3 min
  const fakeRoundNum = (Math.floor(now.getMinutes() / 3) + 1);

  // Round start is next 3-minute mark
  const msIn3min = now.getTime() % (3 * 60 * 1000);
  const nextRound = new Date(now.getTime() + (3 * 60 * 1000 - msIn3min));

  const fakeSeason = { id: fakeSeasonId };
  const fakeRound = { id: 'static_' + fakeSeasonId, name: fakeRoundNum, tradingTime: { start: nextRound.toISOString() } };

  document.getElementById('seasonDisplay').textContent = 'Season #' + fakeSeasonId;
  document.getElementById('matchdayDisplay').textContent = 'MD ' + fakeRoundNum;
  document.getElementById('dqDot').className = 'dq-dot static';
  document.getElementById('dqStatus').textContent = 'Static Mode';

  // Start countdown to next 3-min mark
  updateLiveStatusBar(fakeSeason, fakeRound);

  // Generate events from all teams in current league ‚Äî produce matchups like real rounds do
  const teamCodes = Object.keys(league.teams);
  const shuffled = [...teamCodes].sort(() => Math.sin(fakeSeasonId + fakeRoundNum) - 0.5);
  const fakeEvents = [];
  for (let i = 0; i + 1 < Math.min(shuffled.length, 16); i += 2) {
    const hCode = shuffled[i], aCode = shuffled[i+1];
    fakeEvents.push({
      participants: [{ position: 0, name: hCode }, { position: 1, name: aCode }],
      competition: { name: league.apiName }
    });
  }

  generateLivePredictions(fakeEvents, fakeSeason, fakeRound);

  // Show static mode notice at top
  const loader = document.getElementById('statsLoaderDisplay');
  if (loader) {
    loader.style.background = 'rgba(255,152,0,0.08)';
    loader.style.borderColor = 'rgba(255,152,0,0.4)';
    loader.querySelector('.stats-loader-title').textContent = '‚ö° Static Mode Active ‚Äî Full Predictions Working';
    loader.querySelector('.stats-loader-title').style.color = 'var(--orange)';
    document.getElementById('statsLoaderText').textContent = 'Using proven tier ratings. Tap Refresh anytime to reconnect to live API.';
    document.getElementById('statsProgressFill').style.width = '100%';
    setTimeout(() => { loader.style.display = 'none'; }, 4000);
  }

  // Schedule retry in background (silent)
  setTimeout(() => { fetchLiveData(); }, 35000);
}

function scheduleNextFetch() {
  if (state.refreshTimeout) clearTimeout(state.refreshTimeout);
  if (!isLiveTabActive || !isPageVisible) return;
  state.refreshTimeout = setTimeout(fetchLiveData, 28000 + Math.floor(Math.random() * 7000));
}

function updateLiveStatusBar(season, round) {
  document.getElementById('seasonDisplay').textContent = 'Season #' + season.id;
  document.getElementById('matchdayDisplay').textContent = 'MD ' + round.name;
  if (state.countdownInterval) clearInterval(state.countdownInterval);
  const roundStart = new Date(round.tradingTime.start);
  function update() {
    const diff = roundStart - new Date();
    const cd = document.getElementById('countdownDisplay');
    if (diff <= 0) { cd.textContent = 'LIVE NOW'; cd.style.color = 'var(--red)'; return; }
    const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
    cd.textContent = m + ':' + String(s).padStart(2, '0');
    cd.style.color = m < 2 ? 'var(--red)' : m < 5 ? 'var(--orange)' : 'var(--gold)';
  }
  update(); state.countdownInterval = setInterval(update, 1000);
}

async function generateLivePredictions(events, season, round) {
  const roundStart = new Date(round.tradingTime.start);
  const predictions = [];
  for (const event of events) {
    if (!event.participants || event.participants.length < 2) continue;
    const homeCode = event.participants.find(p => p.position === 0)?.name;
    const awayCode = event.participants.find(p => p.position === 1)?.name;
    if (!homeCode || !awayCode) continue;
    const leagueApiName = event.competition?.name || '';
    const leagueKey = Object.keys(VFL_DATA).find(k => VFL_DATA[k].apiName === leagueApiName || leagueApiName.toLowerCase().includes(VFL_DATA[k].name.toLowerCase().split(' ')[0]));
    if (!leagueKey) continue;
    const pred = calculatePrediction(leagueKey, homeCode, awayCode);
    pred.homeCode = homeCode; pred.awayCode = awayCode; pred.leagueApiName = leagueApiName;
    pred.roundStart = roundStart; pred.season = season; pred.round = round; pred.leagueKey = leagueKey;
    predictions.push(pred);
    // Store in ML data
    await storePrediction(pred, leagueKey, round.id);
  }

  const highConf = predictions.filter(p => p.confidence >= 90 && !p.trapAnalysis?.isDangerous);
  state.highConfPicks = highConf;

  // Update badge
  const badge = document.getElementById('liveBadge');
  const countEl = document.getElementById('highConfCount');
  badge.textContent = highConf.length;
  badge.className = highConf.length > 0 ? 'badge-count show' : 'badge-count';
  countEl.textContent = highConf.length + ' picks';

  // Build acca
  const acca = buildBestAcca(highConf);
  renderAccaPanel(acca);

  if (highConf.length > 0) showNotificationOverlay(highConf, season, round, roundStart);
  renderLivePredictions(predictions, highConf, roundStart);
}

function renderLivePredictions(all, highConf, roundStart) {
  const c = document.getElementById('livePredictionsContainer');
  if (highConf.length === 0) {
    c.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">No 90%+ Clean Picks This Round</div><div class="empty-desc">${all.length} matches analyzed. None pass 90%+ confidence + Trap Shield.<br>Auto-refresh active.</div></div>`;
    return;
  }
  let html = '';
  highConf.sort((a,b) => b.confidence - a.confidence).forEach(pred => { html += renderPredCard(pred, roundStart); });
  c.innerHTML = html;
  startCardCountdowns(roundStart);
}

function renderFormBoxes(form) {
  if (!form || form.length === 0) return '<span style="font-size:8px;color:var(--text2)">No history</span>';
  return form.slice(0,5).map(g => { const cls = g > 2 ? 'fb-over' : g > 0 ? 'fb-under' : 'fb-na'; return `<div class="form-box-mini ${cls}">${g}</div>`; }).join('');
}

function renderTrapPanel(trapAnalysis) {
  if (!trapAnalysis || trapAnalysis.traps.length === 0) return `<div style="background:rgba(0,200,81,0.08);border:1px solid rgba(0,200,81,0.3);border-radius:7px;padding:7px 10px;margin-bottom:8px;font-size:9px;color:var(--green)">üõ°Ô∏è TRAP SHIELD: No traps detected. Clean pick.</div>`;
  const items = trapAnalysis.traps.map(t => `<div class="trap-item"><span class="trap-icon">‚ö°</span><span>${t.text}</span> <span class="trap-level tl-${t.level}">${t.level.toUpperCase()}</span></div>`).join('');
  return `<div class="trap-panel"><div class="trap-panel-title">‚ö†Ô∏è TRAP DETECTOR (${trapAnalysis.traps.length} traps, score: ${trapAnalysis.totalTrapScore})</div>${items}</div>`;
}

function renderVariancePanel(va) {
  if (!va || va.varianceScore < 2) return '';
  const items = va.signals.map(s => `<div class="variance-item"><span>${s.icon}</span><span>${s.text}</span></div>`).join('');
  return `<div class="variance-panel"><div class="variance-title">üí• VARIANCE ENGINE: ${va.variancePrediction || 'Elevated'} (Score: ${va.varianceScore}/10)</div>${items}<div class="variance-score-bar"><div class="variance-score-fill" style="width:${va.varianceScore*10}%"></div></div></div>`;
}

function renderUnderdogPanel(ua) {
  if (!ua || ua.underdogRisk < state.learnedAdjustments.underdogRiskThreshold) return '';
  const items = ua.conditions.map(c => `<div class="underdog-item"><span>${c.icon}</span><span>${c.text}</span></div>`).join('');
  return `<div class="underdog-panel"><div class="underdog-title">üêâ UNDERDOG ALERT (Risk: ${ua.underdogRisk}%)</div>${items}<div style="font-size:9px;font-weight:700;margin-top:5px;color:var(--purple)">${ua.recommendation}</div></div>`;
}

function renderPredCard(pred, roundStart) {
  const isUltra = pred.confidence >= 93;
  const confClass = isUltra ? 'ultra-conf' : 'high-conf';
  const confBadge = isUltra ? 'conf-ultra' : 'conf-high';
  const trapWarned = pred.trapAnalysis?.totalTrapScore >= 6;
  const homeSrc = pred.home.source === 'real' ? '<span class="source-tag st-real">REAL</span>' : '<span class="source-tag st-static">EST</span>';
  const awaySrc = pred.away.source === 'real' ? '<span class="source-tag st-real">REAL</span>' : '<span class="source-tag st-static">EST</span>';

  return `
    <div class="pred-card ${confClass} ${trapWarned ? 'trap-warned' : ''}">
      <div class="pred-card-header">
        <div>
          <div class="pred-match-name">‚öΩ ${pred.homeCode} vs ${pred.awayCode}</div>
          <div class="pred-league-tag">üèÜ ${pred.leagueApiName} ¬∑ Round ${pred.round?.name}</div>
        </div>
        <div style="text-align:right">
          <div class="pred-conf-badge ${confBadge}">${pred.confidence}%</div>
          <div style="font-size:10px;color:var(--gold);text-align:center;margin-top:2px">${pred.stars}</div>
        </div>
      </div>

      <div class="pred-main-bet">
        <div class="pred-bet-label">üéØ Recommended Bet</div>
        <div class="pred-bet-value">${pred.prediction}</div>
      </div>

      ${renderTrapPanel(pred.trapAnalysis)}
      ${renderVariancePanel(pred.varianceAnalysis)}
      ${renderUnderdogPanel(pred.underdogAnalysis)}

      <div class="real-stats-row">
        <div class="real-stat-box">
          <div class="real-stat-team">${pred.homeCode} ${homeSrc}</div>
          <div class="real-stat-grid">
            <span class="stat-pill sp-over">O2.5: ${pred.home.overRate}%</span>
            <span class="stat-pill sp-btts">BTTS: ${pred.home.bttsRate}%</span>
            ${pred.home.avgGoalsFor ? `<span class="stat-pill sp-form">GF: ${pred.home.avgGoalsFor}</span>` : ''}
          </div>
          <div class="form-boxes-row">${renderFormBoxes(pred.home.form)}</div>
        </div>
        <div class="real-stat-box">
          <div class="real-stat-team">${pred.awayCode} ${awaySrc}</div>
          <div class="real-stat-grid">
            <span class="stat-pill sp-over">O2.5: ${pred.away.overRate}%</span>
            <span class="stat-pill sp-btts">BTTS: ${pred.away.bttsRate}%</span>
            ${pred.away.avgGoalsFor ? `<span class="stat-pill sp-form">GF: ${pred.away.avgGoalsFor}</span>` : ''}
          </div>
          <div class="form-boxes-row">${renderFormBoxes(pred.away.form)}</div>
        </div>
      </div>

      ${generateDetailedAnalysis(pred, pred.homeCode, pred.awayCode, pred.leagueKey || state.currentLeague)}

      <div class="pred-card-body">
        <div class="pred-info-item"><div class="pred-info-label">Season</div><div class="pred-info-value">#${pred.season?.id}</div></div>
        <div class="pred-info-item"><div class="pred-info-label">Data Source</div><div class="pred-info-value" style="color:var(--purple)">${pred.dataSource}</div></div>
      </div>

      <div class="pred-countdown">
        <span>‚è±</span><span class="time countdown-timer">Calc...</span><span>to kick off</span>
      </div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button onclick="trackBetFromCard(this,'${pred.homeCode}','${pred.awayCode}','${pred.prediction}',${pred.confidence},'${pred.leagueKey||state.currentLeague}','${pred.leagueApiName||''}')" data-tracked="false"
          style="flex:1;padding:7px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.4);border-radius:6px;color:var(--gold);font-size:9px;font-weight:900;cursor:pointer;font-family:'Rajdhani',sans-serif;letter-spacing:1px">
          ‚ûï TRACK THIS BET
        </button>
      </div>
    </div>
  `;
}

function startCardCountdowns(roundStart) {
  function update() {
    document.querySelectorAll('.countdown-timer').forEach(el => {
      const diff = roundStart - new Date();
      if (diff <= 0) { el.textContent = 'LIVE NOW'; el.className = 'time urgent'; }
      else { const m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000); el.textContent = m+'m '+String(s).padStart(2,'0')+'s'; el.className = m < 2 ? 'time urgent' : 'time'; }
    });
  }
  update();
  if (state.cardTimerInterval) clearInterval(state.cardTimerInterval);
  state.cardTimerInterval = setInterval(update, 1000);
}

function showNotificationOverlay(picks, season, round, roundStart) {
  document.getElementById('notifSeason').textContent = 'Season #' + season.id;
  document.getElementById('notifMatchday').textContent = 'üìÖ Matchday ' + round.name + ' | ' + picks.length + ' Pick' + (picks.length>1?'s':'');
  let html = '';
  picks.slice(0,5).forEach(p => {
    const trapOk = p.trapAnalysis?.isSafe ? 'üõ°Ô∏è Clean' : `‚ö†Ô∏è ${p.trapAnalysis?.traps?.length} traps`;
    html += `<div class="notif-match-item">
      <div class="notif-match-name">‚öΩ ${p.homeCode} vs ${p.awayCode}</div>
      <div class="notif-match-bet">üéØ ${p.prediction}</div>
      <div class="notif-match-conf">Confidence: ${p.confidence}% ¬∑ ${trapOk}</div>
    </div>`;
  });
  document.getElementById('notifMatches').innerHTML = html;
  function updateCD() {
    const diff = roundStart - new Date();
    const el = document.getElementById('notifCountdown');
    if (diff <= 0) { el.textContent = 'üî¥ LIVE NOW ‚Äî Place bets!'; return; }
    const m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000);
    el.textContent = '‚è± Kicks off in: ' + m + ':' + String(s).padStart(2,'0');
  }
  updateCD();
  if (state.notifInterval) clearInterval(state.notifInterval);
  state.notifInterval = setInterval(updateCD, 1000);
  document.getElementById('notifOverlay').classList.add('show');
}

function closeNotification() {
  document.getElementById('notifOverlay').classList.remove('show');
  if (state.notifInterval) clearInterval(state.notifInterval);
}

function showOfflineMode() {
  // Legacy stub ‚Äî handled by activateStaticMode() and showRetryBanner()
  activateStaticMode();
}

// ============================================================
// TEAM STATS TABLE
// ============================================================
function renderTeamStatsTable() {
  const leagueKey = state.currentLeague;
  const league = VFL_DATA[leagueKey];
  const content = document.getElementById('teamStatsContent');
  if (!content) return;
  const rows = Object.entries(league.teams).map(([code, st]) => {
    const eff = getTeamStats(code, leagueKey);
    const trap = detectTraps(code, code, leagueKey);
    const srcTag = eff.source === 'real' ? `<span class="source-tag st-real">REAL</span>` : eff.source === 'blended' ? `<span class="source-tag st-real">BLND</span>` : `<span class="source-tag st-static">EST</span>`;
    const overClass = eff.overRate >= 75 ? 'td-good' : eff.overRate >= 55 ? 'td-mid' : 'td-bad';
    const bttsClass = eff.bttsRate >= 65 ? 'td-good' : eff.bttsRate >= 50 ? 'td-mid' : 'td-bad';
    const formHtml = eff.form.length > 0 ? eff.form.slice(0,5).map(g => g > 2 ? '‚úÖ' : '‚ùå').join('') : '‚Äî';
    return `<tr><td class="td-team">${code}</td><td>${srcTag}</td><td>${eff.realMatches||'‚Äî'}</td><td class="${overClass}">${eff.overRate}%</td><td class="${bttsClass}">${eff.bttsRate}%</td><td>${eff.avgGoalsFor||'‚Äî'}</td><td>${eff.avgGoalsAgainst||'‚Äî'}</td><td>${formHtml}</td><td>T${eff.tier}</td><td style="font-size:8px;color:${st.drawRate>=35?'var(--orange)':'var(--text2)'}">${st.drawRate}%</td></tr>`;
  }).join('');
  content.innerHTML = `<table><thead><tr><th>Team</th><th>Src</th><th>G</th><th>O2.5</th><th>BTTS</th><th>GF</th><th>GA</th><th>Form</th><th>Tier</th><th>Draw%</th></tr></thead><tbody>${rows}</tbody></table>`;
}

// ============================================================
// MANUAL PREDICTOR
// ============================================================
function renderTeamLists() {
  const leagueKey = state.currentLeague;
  const league = VFL_DATA[leagueKey];
  const homeList = document.getElementById('homeTeamList');
  const awayList = document.getElementById('awayTeamList');
  homeList.innerHTML = ''; awayList.innerHTML = '';
  Object.entries(league.teams).forEach(([code, team]) => {
    const eff = getTeamStats(code, leagueKey);
    const rClass = team.tier===1?'r-activator':team.tier===2?'r-strong':team.tier===3?'r-neutral':'r-weak';
    const rText = team.tier===1?'ACT':team.tier===2?'STR':team.tier===3?'NEU':'WEK';
    const liveTag = eff.source === 'real' ? `<span class="team-live-badge">‚òÖ${eff.realMatches}</span>` : '';
    const createItem = (side) => {
      const div = document.createElement('div');
      div.className = 'team-item'; div.dataset.code = code; div.dataset.side = side;
      div.onclick = () => selectTeam(code, side);
      div.innerHTML = `<span class="team-code">${code}</span><span class="team-name">${team.name}</span>${liveTag}<span class="team-rating ${rClass}">${rText}</span>`;
      return div;
    };
    homeList.appendChild(createItem('home'));
    awayList.appendChild(createItem('away'));
  });
  renderTeamStatsTable();
}

function selectTeam(code, side) {
  const leagueKey = state.currentLeague;
  document.querySelectorAll(`.team-item[data-side="${side}"]`).forEach(el => el.classList.remove('selected-home','selected-away'));
  const el = document.querySelector(`.team-item[data-code="${code}"][data-side="${side}"]`);
  if (el) el.classList.add(side==='home'?'selected-home':'selected-away');
  if (side==='home') state.selectedHome = code; else state.selectedAway = code;
  const eff = getTeamStats(code, leagueKey);
  const box = document.getElementById(side==='home'?'homeBox':'awayBox');
  box.classList.add('active');
  box.innerHTML = `<div class="team-box-code">${code}</div><div class="team-box-name">${eff.name}</div><div class="team-box-stats">${eff.source==='real'?`‚òÖ ${eff.realMatches} matches`:'Static'}</div>`;
  if (state.selectedHome && state.selectedAway) generateManualPrediction();
  document.getElementById('addMatchBtn').disabled = !(state.selectedHome && state.selectedAway);
}

function generateManualPrediction() {
  const leagueKey = state.currentLeague;
  const pred = calculatePrediction(leagueKey, state.selectedHome, state.selectedAway);
  const resultEl = document.getElementById('predictionResult');
  const confClass = pred.confidence>=90?'high':pred.confidence>=70?'medium':'low';
  const confColor = pred.confidence>=90?'var(--green)':pred.confidence>=70?'var(--orange)':'var(--red)';
  resultEl.className = 'prediction-result '+confClass;
  resultEl.innerHTML = `<div class="result-title">üéØ Dynamic Prediction</div><div class="result-prediction">${pred.prediction}</div><div class="result-confidence" style="color:${confColor}">${pred.confidence}%</div><div class="result-reason">${pred.reason}</div>`;
  // Show trap/variance in manual predictor
  const trapDisplay = document.getElementById('manualTrapDisplay');
  if (trapDisplay) {
    let html = renderTrapPanel(pred.trapAnalysis) + renderVariancePanel(pred.varianceAnalysis);
    if (pred.underdogAnalysis?.underdogRisk >= state.learnedAdjustments.underdogRiskThreshold) html += renderUnderdogPanel(pred.underdogAnalysis);
    html += generateDetailedAnalysis(pred, state.selectedHome, state.selectedAway, leagueKey);
    trapDisplay.innerHTML = html;
  }
  document.getElementById('ratingCalc').style.display = 'block';
  document.getElementById('homeRatingVal').textContent = pred.homeRating;
  document.getElementById('awayRatingVal').textContent = pred.awayRating;
  document.getElementById('combinedRating').textContent = pred.combined;
  document.getElementById('signalVal').textContent = pred.combined > 0 ? '‚úÖ OVER' : '‚ùå UNDER';
  document.getElementById('signalVal').style.color = pred.combined > 0 ? 'var(--green)' : 'var(--red)';
}

function addMatch() {
  if (!state.selectedHome || !state.selectedAway) return;
  const leagueKey = state.currentLeague;
  const pred = calculatePrediction(leagueKey, state.selectedHome, state.selectedAway);
  const home = getTeamStats(state.selectedHome, leagueKey);
  const away = getTeamStats(state.selectedAway, leagueKey);
  state.matches.push({
    home: state.selectedHome, away: state.selectedAway,
    homeName: home.name, awayName: away.name,
    prediction: pred.prediction, confidence: pred.confidence,
    stars: pred.stars, league: leagueKey, source: pred.dataSource,
    trapScore: pred.trapAnalysis?.totalTrapScore || 0
  });
  updateMatchHistory(); updatePowerMeter(); updateAnalyzer();
}

function updateMatchHistory() {
  const histEl = document.getElementById('matchHistory');
  const listEl = document.getElementById('historyList');
  if (state.matches.length === 0) { histEl.style.display='none'; return; }
  histEl.style.display = 'block';
  listEl.innerHTML = state.matches.map((m, i) => `
    <div class="history-item">
      <div class="history-num">${i+1}</div>
      <div class="history-match"><div>${m.home} vs ${m.away}</div><div style="font-size:8px;color:${m.trapScore>=9?'var(--red)':'var(--text2)'}">${m.trapScore>=9?'‚ö†Ô∏è Traps: '+m.trapScore:'Clean'}</div></div>
      <div class="history-prediction"><div class="history-stars">${m.stars}</div><div style="font-size:9px;font-weight:700;color:var(--gold)">${m.prediction}</div><div class="history-accuracy">${m.confidence}%</div></div>
      <button class="delete-btn" onclick="deleteMatch(${i})">‚úï</button>
    </div>`).join('');
}

function deleteMatch(i) { state.matches.splice(i,1); updateMatchHistory(); updatePowerMeter(); updateAnalyzer(); }
function clearMatches() { state.matches=[]; updateMatchHistory(); updatePowerMeter(); updateAnalyzer(); }

function updatePowerMeter() {
  const pFill = document.getElementById('powerFill'); const pPct = document.getElementById('powerPercent');
  if (state.matches.length === 0) { pFill.style.width='0%'; pFill.textContent='0%'; pPct.textContent='0%'; return; }
  const avg = Math.round(state.matches.reduce((s,m)=>s+m.confidence,0)/state.matches.length);
  pFill.style.width=avg+'%'; pFill.textContent=avg+'%'; pPct.textContent=avg+'%';
}

function updateAnalyzer() {
  const total = state.matches.length;
  const high = state.matches.filter(m=>m.confidence>=90).length;
  const avg = total > 0 ? Math.round(state.matches.reduce((s,m)=>s+m.confidence,0)/total) : 0;
  document.getElementById('statMatches').textContent = total;
  document.getElementById('statHighConf').textContent = high;
  document.getElementById('statAccuracy').textContent = avg+'%';
  if (total > 0) {
    const aEl = document.getElementById('analyzerResult'); aEl.style.display='block';
    const trappy = state.matches.filter(m=>m.trapScore>=9).length;
    document.getElementById('analyzerText').textContent = `${total} matches ¬∑ ${high} high-conf (90%+) ¬∑ ${trappy} trap-warned ¬∑ Avg: ${avg}%. ${high>=3?'STRONG ROUND ‚Äî Acca possible!':trappy>0?'Caution: Remove trap picks first.':'Be selective.'}`;
    const recsEl = document.getElementById('recommendations');
    const cleanHighPicks = state.matches.filter(m=>m.confidence>=90&&m.trapScore<9);
    if (cleanHighPicks.length > 0) {
      recsEl.innerHTML = cleanHighPicks.map(m=>`<div class="strategy-card"><div class="strategy-name">‚úÖ ${m.home} vs ${m.away}</div><div class="strategy-desc">Bet: ${m.prediction} ¬∑ ${m.confidence}% ¬∑ ${m.stars} ¬∑ Clean (trap:${m.trapScore})</div></div>`).join('');
    } else {
      recsEl.innerHTML = `<div class="strategy-card"><div class="strategy-name">‚ö†Ô∏è No Clean Picks</div><div class="strategy-desc">All picks have trap warnings. Review trap analysis before betting.</div></div>`;
    }
  }
}

function switchLeague(league, btn) {
  state.currentLeague = league;
  state.selectedHome = null; state.selectedAway = null;
  document.querySelectorAll('.league-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderTeamLists(); resetPrediction();
}

function resetPrediction() {
  state.selectedHome = null; state.selectedAway = null;
  document.querySelectorAll('.team-item').forEach(el => el.classList.remove('selected-home','selected-away'));
  ['homeBox','awayBox'].forEach(id => {
    const b = document.getElementById(id); b.classList.remove('active');
    b.innerHTML = `<div class="team-box-code">?</div><div class="team-box-name">Select ${id==='homeBox'?'Home':'Away'}</div><div class="team-box-stats"></div>`;
  });
  const res = document.getElementById('predictionResult');
  res.className = 'prediction-result';
  res.innerHTML = `<div class="result-title">Select Teams to Predict</div><div class="result-prediction">--</div><div class="result-confidence" style="font-size:13px;color:var(--text2)">Awaiting selection...</div>`;
  document.getElementById('ratingCalc').style.display = 'none';
  document.getElementById('addMatchBtn').disabled = true;
  const td = document.getElementById('manualTrapDisplay'); if (td) td.innerHTML = '';
}

function showTab(name) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.bottom-nav-item').forEach(n=>n.classList.remove('active'));
  const sec = document.getElementById('tab-'+name); if (sec) sec.classList.add('active');
  const tb = document.getElementById('tab-btn-'+name); if (tb) tb.classList.add('active');
  const nb = document.getElementById('nav-'+name); if (nb) nb.classList.add('active');
  isLiveTabActive = (name==='live');
  if (name === 'teamstats') renderTeamStatsTable();
  if (name === 'mldata') { updateMLDisplay(); renderLearnedAdjustments(); }
  if (name === 'tracker') { renderTracker(); renderChecklist(); }
  scheduleNextFetch();
}

document.addEventListener('visibilitychange', () => { isPageVisible = !document.hidden; if (!document.hidden) scheduleNextFetch(); });

// ============================================================
// PREDICTION TRACKER ‚Äî full persistent bet log
// ============================================================
const LOSS_REASONS = [
  { id:'trap_missed',      label:'ü™§ Trap Missed',          color:'var(--red)',    desc:'High trap score was detected but bet was placed anyway' },
  { id:'underdog_surge',   label:'üêâ Underdog Surge',       color:'var(--purple)', desc:'Low-tier team caused an upset ‚Äî underdog risk was elevated' },
  { id:'rng_correction',   label:'üîÑ RNG Correction',       color:'var(--orange)', desc:'Round correction kicked in after too many consecutive overs' },
  { id:'draw_game',        label:'‚öñÔ∏è Draw/Low Score',       color:'var(--blue)',   desc:'Both teams drew with low goals ‚Äî over prediction failed' },
  { id:'btts_deception',   label:'üé≠ BTTS Deception',       color:'var(--gold)',   desc:'Teams scored but combined goals stayed under 2.5' },
  { id:'algo_balance',     label:'ü§ñ Algorithm Balance',    color:'var(--ml)',     desc:'System balanced outcomes after many favorites winning' },
  { id:'mirror_trap',      label:'ü™û Mirror Match Trap',    color:'var(--text2)',  desc:'Same-tier teams produced an unpredictable result' },
  { id:'wrong_league',     label:'üåç League Variance',      color:'var(--green)',  desc:'Specific league behaved outside normal patterns' },
  { id:'unknown',          label:'‚ùì Unknown / Other',       color:'var(--text2)',  desc:'Result was unexpected with no clear reason' }
];

const CHECKLIST_ITEMS = [
  { id:'conf90',   label:'Confidence ‚â• 90%',         desc:'Only bet picks that scored 90% or higher from the engine',          check: (b) => b && b.confidence >= 90 ? 'pass' : b && b.confidence >= 80 ? 'warn' : 'block' },
  { id:'trapclean',label:'Trap Score = 0',             desc:'No trap warnings detected on this pick ‚Äî shield is green',         check: (b) => b && b.trapScore === 0 ? 'pass' : b && b.trapScore < 9 ? 'warn' : 'block' },
  { id:'underdog', label:'Underdog Risk < 30%',        desc:'No significant underdog conditions met for this match',            check: (b) => b && b.underdogRisk < 30 ? 'pass' : b && b.underdogRisk < 45 ? 'warn' : 'block' },
  { id:'rngstate', label:'RNG Cycle is Safe',          desc:'Current cycle state is not "correction_due" or "upset_imminent"',  check: () => !state.rngCycleState || ['neutral','over_momentum','reversal_due'].includes(state.rngCycleState.state) ? 'pass' : 'warn' },
  { id:'streak',   label:'Not Chasing a Loss',         desc:'You are not increasing stake after a loss ‚Äî discipline check',     check: () => 'manual' },
  { id:'bankroll', label:'Stake ‚â§ 5% of Bankroll',    desc:'Never risk more than 5% of total bankroll on a single bet',        check: () => 'manual' },
  { id:'emotion',  label:'Betting Calmly (Not Emotional)', desc:'No emotional betting ‚Äî frustration/excitement clouds judgment',check: () => 'manual' },
  { id:'round',    label:'Round Has Not Started',      desc:'Do not bet once the round countdown hits 0:30',                    check: () => { const cd = document.getElementById('countdownDisplay'); return cd && cd.textContent !== 'LIVE NOW' ? 'pass' : 'block'; } }
];

let checklistState = {};
let trackerBets = []; // in-memory mirror of IndexedDB tracker store

async function loadTrackerBets() {
  trackerBets = await dbGetAll('trackerBets') || [];
  renderTracker();
}

async function saveTrackerBet(bet) {
  await dbPut('trackerBets', bet);
  const idx = trackerBets.findIndex(b => b.id === bet.id);
  if (idx >= 0) trackerBets[idx] = bet; else trackerBets.unshift(bet);
  renderTracker();
}

async function confirmClearTracker() {
  if (confirm('‚ö†Ô∏è Clear ALL tracker data? This cannot be undone.')) {
    await dbClear('trackerBets');
    trackerBets = [];
    renderTracker();
  }
}

function trackBetFromCard(btn, homeCode, awayCode, prediction, confidence, leagueKey, leagueApiName) {
  if (btn.dataset.tracked === 'true') return;
  const bet = {
    id: `${homeCode}_${awayCode}_${Date.now()}`,
    homeCode, awayCode, prediction,
    confidence: parseInt(confidence),
    leagueKey, leagueApiName,
    timestamp: Date.now(),
    result: null,      // 'won' | 'lost' | 'void'
    actualGoals: null,
    lossReason: null,
    lossNote: '',
    trapScore: 0,
    underdogRisk: 0
  };
  // Grab extra data from last prediction if available
  const lastPred = state.highConfPicks?.find(p => p.homeCode === homeCode && p.awayCode === awayCode);
  if (lastPred) {
    bet.trapScore = lastPred.trapAnalysis?.totalTrapScore || 0;
    bet.underdogRisk = lastPred.underdogAnalysis?.underdogRisk || 0;
  }
  saveTrackerBet(bet);
  btn.textContent = '‚úÖ TRACKED';
  btn.style.background = 'rgba(0,200,81,0.2)';
  btn.style.borderColor = 'var(--green)';
  btn.style.color = 'var(--green)';
  btn.dataset.tracked = 'true';
  btn.disabled = true;

  // Update tracker badge
  const pending = trackerBets.filter(b => b.result === null).length + 1;
  const tb = document.getElementById('trackerBadge');
  if (tb && pending > 0) { tb.textContent = pending; tb.className = 'badge-count show'; }
}

async function markBetResult(id, result) {
  const bet = trackerBets.find(b => b.id === id);
  if (!bet) return;
  bet.result = result;
  if (result === 'lost') {
    // Auto-diagnose loss reason
    bet.lossReason = autoDetectLossReason(bet);
  }
  await saveTrackerBet(bet);
}

async function setBetLossReason(id, reasonId) {
  const bet = trackerBets.find(b => b.id === id);
  if (!bet) return;
  bet.lossReason = reasonId;
  await saveTrackerBet(bet);
}

async function setBetGoals(id, goals) {
  const bet = trackerBets.find(b => b.id === id);
  if (!bet) return;
  bet.actualGoals = parseInt(goals);
  if (bet.result === null) bet.result = bet.actualGoals > 2 ? 'won' : 'lost';
  if (bet.result === 'lost') bet.lossReason = autoDetectLossReason(bet);
  await saveTrackerBet(bet);
}

function autoDetectLossReason(bet) {
  if (bet.trapScore >= 9) return 'trap_missed';
  if (bet.underdogRisk >= 40) return 'underdog_surge';
  if (state.rngCycleState?.state === 'correction_due') return 'rng_correction';
  if (bet.actualGoals === 2 || bet.actualGoals === 1) return 'draw_game';
  return 'unknown';
}

function renderTracker() {
  const bets = [...trackerBets].sort((a,b) => b.timestamp - a.timestamp);
  const won   = bets.filter(b => b.result === 'won').length;
  const lost  = bets.filter(b => b.result === 'lost').length;
  const voids = bets.filter(b => b.result === 'void').length;
  const total = won + lost + voids;
  const settled = won + lost;
  const winRate = settled > 0 ? Math.round((won / settled) * 100) : 0;

  const el = (id, v) => { const e = document.getElementById(id); if (e) e.textContent = v; };
  el('trk-wins', won); el('trk-losses', lost); el('trk-voids', voids);
  el('trk-rate', winRate + '%'); el('trk-total', total);

  // Streak calculation
  let streak = 0, bestStreak = 0, curBest = 0, streakType = null;
  const settled_sorted = bets.filter(b => b.result === 'won' || b.result === 'lost');
  for (const b of settled_sorted) {
    if (streakType === null) { streakType = b.result; streak = 1; curBest = 1; }
    else if (b.result === streakType) { streak++; curBest++; }
    else { if (streakType === 'won') bestStreak = Math.max(bestStreak, curBest); streakType = b.result; curBest = 1; }
  }
  if (streakType === 'won') bestStreak = Math.max(bestStreak, curBest);
  const currentStreak = settled_sorted.length > 0 ? streak : 0;
  const currentStreakType = streakType;
  el('trk-streak', (currentStreakType === 'lost' ? '-' : '+') + currentStreak);
  el('trk-best-streak', '+' + bestStreak);
  const streakEl = document.getElementById('trk-streak');
  if (streakEl) streakEl.style.color = currentStreakType === 'won' ? 'var(--green)' : currentStreakType === 'lost' ? 'var(--red)' : 'var(--gold)';

  // Streak dots (last 15)
  const dotsEl = document.getElementById('trk-streak-dots');
  if (dotsEl) {
    dotsEl.innerHTML = settled_sorted.slice(0, 15).map(b => `<div class="sd ${b.result === 'won' ? 'w' : b.result === 'void' ? 'p' : 'l'}">${b.result === 'won' ? 'W' : b.result === 'void' ? 'V' : 'L'}</div>`).join('');
  }

  // Tracker badge
  const pending = bets.filter(b => b.result === null).length;
  const tb = document.getElementById('trackerBadge');
  if (tb) { if (pending > 0) { tb.textContent = pending; tb.className = 'badge-count show'; } else tb.className = 'badge-count'; }

  // ROI calc
  calcROI();

  // Insights
  renderInsights(bets);

  // Loss reasons
  renderLossReasons(bets.filter(b => b.result === 'lost'));

  // Bet log
  renderBetLog(bets);
}

function calcROI() {
  const stake = parseFloat(document.getElementById('roiStake')?.value || 10);
  const odds  = parseFloat(document.getElementById('roiOdds')?.value || 1.80);
  const won   = trackerBets.filter(b => b.result === 'won').length;
  const lost  = trackerBets.filter(b => b.result === 'lost').length;
  const total = won + lost;
  if (total === 0) return;
  const totalStaked = total * stake;
  const totalReturn = won * stake * odds;
  const profit = totalReturn - totalStaked;
  const roi = ((profit / totalStaked) * 100).toFixed(1);
  const el = (id, v, c) => { const e = document.getElementById(id); if (e) { e.textContent = v; if (c) e.style.color = c; } };
  el('roiProfit', (profit >= 0 ? '+' : '') + 'K' + Math.abs(profit).toFixed(0), profit >= 0 ? 'var(--green)' : 'var(--red)');
  el('roiReturn', (roi >= 0 ? '+' : '') + roi + '%', parseFloat(roi) >= 0 ? 'var(--green)' : 'var(--red)');
  el('roiStaked', 'K' + totalStaked.toFixed(0));
}

function renderInsights(bets) {
  const settled = bets.filter(b => b.result === 'won' || b.result === 'lost');
  if (settled.length === 0) return;

  // By bet type
  const btMap = {};
  settled.forEach(b => {
    const t = b.prediction?.split(' ').slice(0,2).join(' ') || 'Other';
    if (!btMap[t]) btMap[t] = {w:0,l:0};
    if (b.result === 'won') btMap[t].w++; else btMap[t].l++;
  });
  const btHtml = Object.entries(btMap).sort((a,b) => (b[1].w/(b[1].w+b[1].l)) - (a[1].w/(a[1].w+a[1].l))).slice(0,5).map(([t,v]) => {
    const r = Math.round(v.w/(v.w+v.l)*100);
    return `<div class="insight-row"><span class="ir-label">${t}</span><span class="ir-val" style="color:${r>=60?'var(--green)':r>=40?'var(--orange)':'var(--red)'}">${r}% (${v.w+v.l})</span></div>`;
  }).join('');
  const btEl = document.getElementById('insightBetType'); if (btEl) btEl.innerHTML = btHtml || '<div style="font-size:9px;color:var(--text2)">No data</div>';

  // By league
  const lgMap = {};
  settled.forEach(b => {
    const l = b.leagueKey || 'unknown';
    if (!lgMap[l]) lgMap[l] = {w:0,l:0};
    if (b.result === 'won') lgMap[l].w++; else lgMap[l].l++;
  });
  const lgHtml = Object.entries(lgMap).sort((a,b) => (b[1].w/(b[1].w+b[1].l)) - (a[1].w/(a[1].w+a[1].l))).slice(0,6).map(([l,v]) => {
    const r = Math.round(v.w/(v.w+v.l)*100);
    return `<div class="insight-row"><span class="ir-label">${l}</span><span class="ir-val" style="color:${r>=60?'var(--green)':r>=40?'var(--orange)':'var(--red)'}">${r}% (${v.w+v.l})</span></div>`;
  }).join('');
  const lgEl = document.getElementById('insightLeague'); if (lgEl) lgEl.innerHTML = lgHtml || '<div style="font-size:9px;color:var(--text2)">No data</div>';

  // By confidence bucket
  const bands = [{ lbl:'95%+',min:95,max:100 },{ lbl:'90-94%',min:90,max:95 },{ lbl:'85-89%',min:85,max:90 },{ lbl:'<85%',min:0,max:85 }];
  const confHtml = bands.map(band => {
    const sub = settled.filter(b => b.confidence >= band.min && b.confidence < band.max);
    if (sub.length === 0) return '';
    const w = sub.filter(b=>b.result==='won').length;
    const r = Math.round(w/sub.length*100);
    return `<div class="insight-row"><span class="ir-label">${band.lbl}</span><span class="ir-val" style="color:${r>=60?'var(--green)':r>=40?'var(--orange)':'var(--red)'}">${r}% (${sub.length})</span></div>`;
  }).join('');
  const cfEl = document.getElementById('insightConf'); if (cfEl) cfEl.innerHTML = confHtml || '<div style="font-size:9px;color:var(--text2)">No data</div>';

  // By hour of day
  const hourMap = {};
  settled.forEach(b => {
    const h = new Date(b.timestamp).getHours();
    const label = h + ':00-' + (h+1) + ':00';
    if (!hourMap[label]) hourMap[label] = {w:0,l:0};
    if (b.result === 'won') hourMap[label].w++; else hourMap[label].l++;
  });
  const timeHtml = Object.entries(hourMap).sort((a,b)=>(b[1].w/(b[1].w+b[1].l))-(a[1].w/(a[1].w+a[1].l))).slice(0,5).map(([t,v]) => {
    const r = Math.round(v.w/(v.w+v.l)*100);
    return `<div class="insight-row"><span class="ir-label">${t}</span><span class="ir-val" style="color:${r>=60?'var(--green)':r>=40?'var(--orange)':'var(--red)'}">${r}% (${v.w+v.l})</span></div>`;
  }).join('');
  const timeEl = document.getElementById('insightTime'); if (timeEl) timeEl.innerHTML = timeHtml || '<div style="font-size:9px;color:var(--text2)">No data</div>';
}

function renderLossReasons(losses) {
  const el = document.getElementById('lossReasonBars');
  const countEl = document.getElementById('lrp-count');
  if (!el) return;
  if (countEl) countEl.textContent = losses.length + ' losses analysed';
  if (losses.length === 0) { el.innerHTML = '<div style="font-size:9px;color:var(--text2);padding:5px">No losses yet. Keep it up! üèÜ</div>'; return; }
  const rmap = {};
  losses.forEach(b => { const r = b.lossReason || 'unknown'; if (!rmap[r]) rmap[r] = 0; rmap[r]++; });
  const max = Math.max(...Object.values(rmap));
  el.innerHTML = Object.entries(rmap).sort((a,b)=>b[1]-a[1]).map(([id, cnt]) => {
    const info = LOSS_REASONS.find(r=>r.id===id) || { label: id, color:'var(--text2)', desc:'' };
    const pct = Math.round((cnt/losses.length)*100);
    const barW = Math.round((cnt/max)*100);
    return `
      <div class="reason-bar-row">
        <div class="reason-bar-label">
          <span class="rl-name">${info.label}</span>
          <span class="rl-cnt">${cnt}x (${pct}%)</span>
        </div>
        <div style="font-size:8px;color:var(--text2);margin-bottom:2px">${info.desc}</div>
        <div class="reason-bar"><div class="reason-bar-fill" style="width:${barW}%;background:${info.color};opacity:0.8"></div></div>
      </div>`;
  }).join('');
}

function renderBetLog(bets) {
  const el = document.getElementById('betLogList');
  if (!el) return;
  if (bets.length === 0) {
    el.innerHTML = '<div style="font-size:10px;color:var(--text2);text-align:center;padding:20px">No bets logged yet.<br><span style="font-size:9px">Click "TRACK THIS BET" on any Live prediction card.</span></div>';
    return;
  }
  el.innerHTML = bets.map(b => {
    const resultClass = b.result || 'pending';
    const d = new Date(b.timestamp);
    const timeStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const reasonInfo = b.lossReason ? LOSS_REASONS.find(r=>r.id===b.lossReason) : null;
    const badgeHtml = b.result ? `<span class="bl-badge ${b.result}">${b.result.toUpperCase()}</span>` : `<span class="bl-badge" style="background:rgba(255,152,0,0.2);color:var(--orange)">PENDING</span>`;

    const goalInput = b.result === null ? `
      <div style="display:flex;align-items:center;gap:6px;margin-top:6px">
        <span style="font-size:9px;color:var(--text2)">Actual goals:</span>
        <input type="number" min="0" max="15" placeholder="e.g. 3" value="${b.actualGoals || ''}"
          onchange="setBetGoals('${b.id}', this.value)"
          style="width:55px;background:var(--card3);border:1px solid var(--border);border-radius:4px;color:var(--gold);font-size:11px;font-weight:700;padding:3px 6px;font-family:'Rajdhani',sans-serif">
      </div>` : `<div style="font-size:9px;color:var(--text2);margin-top:3px">‚öΩ Goals: ${b.actualGoals !== null ? b.actualGoals : '‚Äî'}</div>`;

    const reasonSelect = b.result === 'lost' ? `
      <select onchange="setBetLossReason('${b.id}',this.value)"
        style="width:100%;margin-top:5px;background:var(--card3);border:1px solid rgba(255,53,71,0.4);border-radius:4px;color:var(--red);font-size:9px;padding:4px;outline:none">
        <option value="">‚Äî Select Loss Reason ‚Äî</option>
        ${LOSS_REASONS.map(r=>`<option value="${r.id}" ${b.lossReason===r.id?'selected':''}>${r.label}</option>`).join('')}
      </select>` : '';

    return `
      <div class="bl-item ${b.result || ''}">
        ${badgeHtml}
        <div class="bl-match">‚öΩ ${b.homeCode} vs ${b.awayCode}</div>
        <div class="bl-pred ${b.result || ''}">${b.prediction} ¬∑ ${b.confidence}%</div>
        <div class="bl-meta">${b.leagueApiName || b.leagueKey} ¬∑ ${timeStr} ¬∑ Trap:${b.trapScore} ¬∑ Udg:${b.underdogRisk}%</div>
        ${goalInput}
        ${reasonSelect}
        ${reasonInfo ? `<div class="bl-reason">üîç Loss reason: ${reasonInfo.label} ‚Äî ${reasonInfo.desc}</div>` : ''}
        ${b.result === null ? `
        <div class="bl-actions">
          <button class="bl-btn won-btn" onclick="markBetResult('${b.id}','won')">‚úÖ WON</button>
          <button class="bl-btn lost-btn" onclick="markBetResult('${b.id}','lost')">‚ùå LOST</button>
          <button class="bl-btn void-btn" onclick="markBetResult('${b.id}','void')">‚Ü© VOID</button>
        </div>` : ''}
      </div>`;
  }).join('');
}

// ============================================================
// PRE-BET CHECKLIST
// ============================================================
function renderChecklist(selectedBet) {
  const el = document.getElementById('checklistItems');
  const vEl = document.getElementById('checklistVerdict');
  if (!el) return;

  let passes = 0, warns = 0, blocks = 0;

  el.innerHTML = CHECKLIST_ITEMS.map(item => {
    const auto = item.check(selectedBet);
    const state_val = checklistState[item.id];
    // Manual items use checkbox state; auto items use computed result
    let status = auto === 'manual' ? (state_val || 'pending') : auto;
    if (status === 'pass') passes++;
    else if (status === 'warn') warns++;
    else if (status === 'block') blocks++;

    const icon = status === 'pass' ? '‚úì' : status === 'warn' ? '!' : status === 'block' ? '‚úó' : '‚óã';
    const cls = status === 'pass' ? 'checked' : status === 'warn' ? 'warn' : status === 'block' ? 'block' : '';
    const statusLabel = status === 'pass' ? 'PASS' : status === 'warn' ? 'CAUTION' : status === 'block' ? 'STOP' : 'TAP TO CHECK';
    const statusCls = status === 'pass' ? 'pass' : status === 'warn' ? 'warn' : status === 'block' ? 'block' : 'warn';

    return `
      <div class="checklist-item" onclick="toggleChecklist('${item.id}','${auto}')">
        <div class="ci-check ${cls}">${icon}</div>
        <div class="ci-text">
          <div class="ci-label">${item.label}</div>
          <div class="ci-desc">${item.desc}</div>
        </div>
        <div class="ci-status ${statusCls}">${statusLabel}</div>
      </div>`;
  }).join('');

  // Verdict
  if (vEl) {
    vEl.style.display = 'block';
    if (blocks > 0) {
      vEl.className = 'checklist-verdict cv-red';
      vEl.innerHTML = `üî¥ DO NOT BET ‚Äî ${blocks} critical issue${blocks>1?'s':''} detected. Fix before placing any stake.`;
    } else if (warns >= 3) {
      vEl.className = 'checklist-verdict cv-orange';
      vEl.innerHTML = `üü° HIGH CAUTION ‚Äî ${warns} warnings. Reduce stake significantly or skip this bet.`;
    } else if (warns >= 1) {
      vEl.className = 'checklist-verdict cv-orange';
      vEl.innerHTML = `üü° PROCEED WITH CAUTION ‚Äî ${warns} warning(s). Max 2% bankroll stake recommended.`;
    } else {
      vEl.className = 'checklist-verdict cv-green';
      vEl.innerHTML = `‚úÖ ALL CLEAR ‚Äî ${passes} checks passed. Safe to bet at normal stake (3-5% bankroll).`;
    }
  }
}

function toggleChecklist(id, auto) {
  if (auto !== 'manual') return; // Auto items can't be toggled
  const current = checklistState[id] || 'pending';
  checklistState[id] = current === 'pending' ? 'pass' : current === 'pass' ? 'warn' : current === 'warn' ? 'block' : 'pending';
  renderChecklist();
}

function resetChecklist() {
  checklistState = {};
  renderChecklist();
}

// ============================================================
// INIT
// ============================================================
window.addEventListener('load', async () => {
  try {
    await initDB();
    console.log('[DB] IndexedDB initialized');
    await loadLearnedAdjustments();
    await updateMLDisplay();
    await loadTrackerBets();
  } catch(e) {
    console.warn('[DB] IndexedDB init failed, using in-memory mode:', e);
  }
  renderTeamLists();
  updatePowerMeter();
  renderChecklist();
  fetchLiveData();
});
</script>
</body>
</html>
